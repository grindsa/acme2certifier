name: "tunnel_setup"
description: "tunnel_setup"
inputs:
  SSH_KEY:
    description: "SSH access key"
    required: true
  SSH_KNOWN_HOSTS:
    description: "SSH known hosts"
    required: true
  MSCA_FQDN_WOTLD:
    description: "FQDN without top level domain"
    required: true
  MSCA_FQDN:
    description: "FQDN"
    required: true
  MSCA_IP:
    description: "WCCE host"
    required: true
  SSH_USER:
    description: "SSH user"
    required: true
  SSH_HOST:
    description: "SSH host"
    required: true
  SSH_PORT:
    description: "SSH port"
    required: true
  NAME_SPACE:
    description: "namespace"
    required: true
    default: "acme"

runs:
  using: "composite"
  steps:
  - name: "Sleep for 10s"
    uses: juliangruber/sleep-action@v2.0.3
    with:
      time: 10s

  - name: "Prepare ssh environment on ramdisk "
    run: |
      sudo mkdir -p /tmp/rd
      sudo mount -t tmpfs -o size=5M none /tmp/rd
      sudo echo "$SSH_KEY" > /tmp/rd/ak.tmp
      sudo chmod 600 /tmp/rd/ak.tmp
      sudo echo "$KNOWN_HOSTS" > /tmp/rd/known_hosts
    env:
      SSH_KEY: ${{ inputs.SSH_KEY }}
      KNOWN_HOSTS: ${{ inputs.SSH_KNOWN_HOSTS }}
    shell: bash

  - name: "Setup ssh forwarder"
    run: |
        docker run -d --rm --network $NAME_SPACE --name=$MSCA_FQDN_WOTLD  -e "MAPPINGS=445:$MSCA_IP:445; 443:$MSCA_IP:443; 88:$MSCA_IP:88" -e "SSH_HOST=$SSH_HOST" -e "SSH_PORT=$SSH_PORT" -e "SSH_USER=$SSH_USER" -p 443:443 -p 445:445 -p 88:88 -v "/tmp/rd/ak.tmp:/ssh_key:ro" davidlor/ssh-port-forward-client:dev
    env:
      SSH_USER: ${{ inputs.SSH_USER }}
      SSH_HOST: ${{ inputs.SSH_HOST }}
      SSH_PORT: ${{ inputs.SSH_PORT }}
      MSCA_IP: ${{ inputs.MSCA_IP }}
      MSCA_FQDN_WOTLD: ${{ inputs.MSCA_FQDN_WOTLD }}
      NAME_SPACE: ${{ inputs.NAME_SPACE }}
    shell: bash

  - name: "Sleep for 10s"
    uses: juliangruber/sleep-action@v2.0.3
    with:
      time: 10s

  - name: "Test conection to mscertsrv via ssh tunnel"
    run: |
      docker run -i --rm --network $NAME_SPACE curlimages/curl --insecure -f https://$MSCA_FQDN
    env:
      MSCA_FQDN: ${{ inputs.MSCA_FQDN }}
      NAME_SPACE: ${{ inputs.NAME_SPACE }}
    shell: bash
