name: CA-Handler Tests - MSCA
on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to run the workflow on'
        required: true
        default: 'main'
      run_id:
        description: 'Run ID of the producing workflow'
        required: true
        default: '0'
      sha:
        description: 'SHA of the commit to run the workflow on'
        required: true
        default: ''
      called_by_workflow:
        description: 'Name of the producing workflow'
        required: true
        default: 'manual-trigger'
      full_ref:
        description: 'Full git ref of the commit to run the workflow on'
        required: false
        default: ''

jobs:

  # ---------------------------------------------------------
  # Quick guard to validate incoming payload
  # ---------------------------------------------------------
  guard:
    runs-on: ubuntu-latest
    if: >
      ${{
        inputs.sha != '' &&
        inputs.run_id != '' &&
        inputs.branch != ''
      }} && github.repository == 'grindsa/acme2certifier'
    steps:
      - run: |
          echo "Triggered by SHA:    $SHA"
          echo "From branch:         $BRANCH"
          echo "Producer run_id:     $RUN_ID"
        env:
          SHA: ${{ inputs.sha }}
          BRANCH: ${{ inputs.branch }}
          RUN_ID: ${{ inputs.run_id }}

  # ---------------------------------------------------------
  # Test mscertserv - container images (matrix from payload)
  # ---------------------------------------------------------
  mscertserv-test-containers:
    needs: guard
    runs-on: ubuntu-latest
    if: github.repository == 'grindsa/acme2certifier1'
    strategy:
      fail-fast: false
      matrix:
        websrv: ['apache2', 'nginx']
        dbhandler: ['wsgi', 'django']
    name: "mscertsrv_handler_tests"

    steps:
      - name: "checkout GIT"
        uses: actions/checkout@v4

      - name: "Parse MSCA_CFG secrets"
        uses: ./.github/actions/parse-json-secret
        with:
          json_secret: ${{ secrets.MSCA_CFG }}

      - name: "Parse GH_CFG secrets"
        uses: ./.github/actions/parse-json-secret
        with:
          json_secret: ${{ secrets.GH_CFG }}

      - name: "Parse SSH_TUNNEL_CFG secrets"
        uses: ./.github/actions/parse-json-secret
        with:
          json_secret: ${{ secrets.SSH_TUNNEL_CFG }}

      - name: "Download and import container"
        uses: ./.github/actions/container_load
        with:
          RUN_ID: ${{ inputs.run_id }}
          ARTIFACT_NAME: a2c-${{ inputs.run_id }}.${{ matrix.websrv }}.${{ matrix.dbhandler }}.tar
          DESTINATION_PATH: /tmp
          TOKEN: ${{ secrets.GH_WF_TOKEN }}
          REPO: ${{ github.repository }}

      - name: "Prepare container environment"
        uses: ./.github/actions/container_prep
        with:
          DB_HANDLER: ${{ matrix.dbhandler }}
          WEB_SRV: ${{ matrix.websrv }}
          CONTAINER_BUILD: false
          NAME_SPACE: local

      - name: "Get runner ip"
        run: |
          echo RUNNER_IP=$(ip addr show eth0 | grep -i "inet " | cut -d ' ' -f 6 | cut -d '/' -f 1) >> $GITHUB_ENV
          echo RUNNER_PATH=$(pwd | sed 's_/_\\/_g') >> $GITHUB_ENV

      - run: echo "runner IP is $RUNNER_IP"
        env:
          RUNNER_IP: ${{ env.RUNNER_IP }}

      - name: "Setup tunnel"
        uses: ./.github/actions/wf_specific/ms_ca_handler/tunnel_setup
        with:
          SSH_USER: ${{ env.SSH_USER }}
          SSH_HOST: ${{ env.SSH_HOST }}
          SSH_PORT: ${{ env.SSH_PORT }}
          MSCA_IP: ${{ env.MSCA_IP }}
          MSCA_FQDN_WOTLD: ${{ env.MSCA_FQDN_WOTLD }}
          MSCA_FQDN: ${{ env.MSCA_FQDN }}
          SSH_KNOWN_HOSTS: ${{ env.SSH_KNOWN_HOSTS }}
          SSH_KEY: ${{ env.SSH_KEY }}
          NAME_SPACE: local

      - name: "KRB Headerinfo - Setup a2c with mscertsrv_ca_handler"
        run: |
          sudo touch examples/Docker/data/ca_certs.pem
          sudo chmod 777 examples/Docker/data/ca_certs.pem
          sudo cp test/ca/certsrv_ca_certs.pem examples/Docker/data/ca_certs.pem
          sudo touch examples/Docker/data/acme_srv.cfg
          sudo chmod 777 examples/Docker/data/acme_srv.cfg
          sudo head -n -8 .github/openssl_ca_handler.py_acme_srv_default_handler.cfg > examples/Docker/data/acme_srv.cfg
          sudo echo "handler_file: examples/ca_handler/mscertsrv_ca_handler.py" >> examples/Docker/data/acme_srv.cfg
          sudo echo "host: $MSCA_FQDN" >> examples/Docker/data/acme_srv.cfg
          sudo echo "user: $MSCA_USER" >> examples/Docker/data/acme_srv.cfg
          sudo echo "password: $MSCA_PASSWORD" >> examples/Docker/data/acme_srv.cfg
          sudo echo "auth_method: gssapi" >> examples/Docker/data/acme_srv.cfg
          sudo echo "template: $MSCA_TEMPLATE" >> examples/Docker/data/acme_srv.cfg
          sudo echo "ca_bundle: /var/www/acme2certifier/volume/ca_certs.pem" >> examples/Docker/data/acme_srv.cfg
          sudo echo "krb5_config: /var/www/acme2certifier/volume/krb5.conf" >> examples/Docker/data/acme_srv.cfg
          sudo echo "verify: False" >> examples/Docker/data/acme_srv.cfg
          sudo echo "request_timeout: 30" >> examples/Docker/data/acme_srv.cfg
          sudo sed -i "s/tnauthlist_support: False/tnauthlist_support: False\nheader_info_list: [\"HTTP_USER_AGENT\"]/g" examples/Docker/data/acme_srv.cfg
          sudo sed -i "s/revocation_reason_check_disable: False/revocation_reason_check_disable: False\nenrollment_timeout: 40/g" examples/Docker/data/acme_srv.cfg

          sudo touch examples/Docker/data/krb5.conf
          sudo chmod 777 examples/Docker/data/krb5.conf
          cat <<EOF > examples/Docker/data/krb5.conf
          $KRB5_CONF
          EOF

      - name: "Bring up a2c container"
        uses: ./.github/actions/container_up
        with:
          DB_HANDLER: ${{ matrix.dbhandler }}
          WEB_SRV: ${{ matrix.websrv }}
          NAME_SPACE: local

      - name: "Sleep for 10s"
        uses: juliangruber/sleep-action@v2.0.3
        with:
          time: 10s

      - name: "KRB Headerinfo - Enrollment"
        uses: ./.github/actions/wf_specific/ms_ca_handler/enroll_default_headerinfo
        with:
          NAME_SPACE: local

      - name: "Check container configuration"
        uses: ./.github/actions/container_check
        with:
          DB_HANDLER: ${{ matrix.dbhandler }}
          WEB_SRV: ${{ matrix.websrv }}

      - name: "KRB ACME Profiling - Setup a2c with mscertsrv_ca_handler"
        run: |
          sudo touch examples/Docker/data/ca_certs.pem
          sudo chmod 777 examples/Docker/data/ca_certs.pem
          sudo cp test/ca/certsrv_ca_certs.pem examples/Docker/data/ca_certs.pem
          sudo touch examples/Docker/data/acme_srv.cfg
          sudo chmod 777 examples/Docker/data/acme_srv.cfg
          sudo head -n -8 .github/openssl_ca_handler.py_acme_srv_default_handler.cfg > examples/Docker/data/acme_srv.cfg
          sudo echo "handler_file: examples/ca_handler/mscertsrv_ca_handler.py" >> examples/Docker/data/acme_srv.cfg
          sudo echo "host: $MSCA_FQDN" >> examples/Docker/data/acme_srv.cfg
          sudo echo "user: $MSCA_USER" >> examples/Docker/data/acme_srv.cfg
          sudo echo "password: $MSCA_PASSWORD" >> examples/Docker/data/acme_srv.cfg
          sudo echo "auth_method: gssapi" >> examples/Docker/data/acme_srv.cfg
          sudo echo "template: $MSCA_TEMPLATE" >> examples/Docker/data/acme_srv.cfg
          sudo echo "ca_bundle: /var/www/acme2certifier/volume/ca_certs.pem" >> examples/Docker/data/acme_srv.cfg
          sudo echo "krb5_config: /var/www/acme2certifier/volume/krb5.conf" >> examples/Docker/data/acme_srv.cfg
          sudo echo "verify: False" >> examples/Docker/data/acme_srv.cfg
          sudo echo "request_timeout: 30" >> examples/Docker/data/acme_srv.cfg
          sudo echo "enrollment_config_log: True" >> examples/Docker/data/acme_srv.cfg
          sudo sed -i "s/tnauthlist_support: False/tnauthlist_support: False\nprofiles={\"WebServerModified\": \"http:\/\/foo.bar\/acmeca1\", \"WebServer\": \"http:\/\/foo.bar\/acmeca2\", \"profile3\": \"http:\/\/foo.bar\/profile3\"}/g" examples/Docker/data/acme_srv.cfg
          sudo sed -i "s/revocation_reason_check_disable: False/revocation_reason_check_disable: False\nenrollment_timeout: 40/g" examples/Docker/data/acme_srv.cfg

          sudo touch examples/Docker/data/krb5.conf
          sudo chmod 777 examples/Docker/data/krb5.conf
          cat <<EOF > examples/Docker/data/krb5.conf
          $KRB5_CONF
          EOF
          cd examples/Docker/
          docker compose restart

      - name: "Sleep for 10s"
        uses: juliangruber/sleep-action@v2.0.3
        with:
          time: 10s

      - name: "KRB ACME Profiling - Enrollment"
        uses: ./.github/actions/wf_specific/ms_ca_handler/enroll_acmeprofile
        with:
          NAME_SPACE: local
          DEPLOYMENT_TYPE: container

      - name: "NTLM Headerinfo - Setup a2c with mscertsrv_ca_handler"
        run: |
          sudo touch examples/Docker/data/acme_srv.cfg
          sudo chmod 777 examples/Docker/data/acme_srv.cfg
          sudo head -n -8 .github/openssl_ca_handler.py_acme_srv_default_handler.cfg > examples/Docker/data/acme_srv.cfg
          sudo echo "handler_file: examples/ca_handler/mscertsrv_ca_handler.py" >> examples/Docker/data/acme_srv.cfg
          sudo echo "host: $MSCA_FQDN" >> examples/Docker/data/acme_srv.cfg
          sudo echo "user: $MSCA_USER" >> examples/Docker/data/acme_srv.cfg
          sudo echo "password: $MSCA_PASSWORD" >> examples/Docker/data/acme_srv.cfg
          sudo echo "auth_method: ntlm" >> examples/Docker/data/acme_srv.cfg
          sudo echo "template: $MSCA_TEMPLATE" >> examples/Docker/data/acme_srv.cfg
          sudo echo "ca_bundle: /var/www/acme2certifier/volume/ca_certs.pem" >> examples/Docker/data/acme_srv.cfg
          sudo echo "verify: False" >> examples/Docker/data/acme_srv.cfg
          sudo echo "request_timeout: 30" >> examples/Docker/data/acme_srv.cfg
          sudo sed -i "s/tnauthlist_support: False/tnauthlist_support: False\nheader_info_list: [\"HTTP_USER_AGENT\"]/g" examples/Docker/data/acme_srv.cfg
          sudo sed -i "s/revocation_reason_check_disable: False/revocation_reason_check_disable: False\nenrollment_timeout: 40/g" examples/Docker/data/acme_srv.cfg

      - name: "NTLM Headerinfo - Enrollment"
        uses: ./.github/actions/wf_specific/ms_ca_handler/enroll_default_headerinfo
        with:
          NAME_SPACE: local

      - name: "NTLM Headerinfo - Setup a2c with mscertsrv_ca_handler with allowed_domainlist configuration"
        run: |
          sudo sed -i "s/challenge_validation_disable: False/challenge_validation_disable: True/g" examples/Docker/data/acme_srv.cfg
          sudo echo "allowed_domainlist: [\"*.acme\", \"foo1.bar\", \"*.bar.local\"]" >> examples/Docker/data/acme_srv.cfg
          cd examples/Docker/
          docker compose restart

      - name: "NTLM Headerinfo - enrollment allowed domainlist"
        uses: ./.github/actions/wf_specific/ms_ca_handler/enroll_allowed_domain_list
        with:
          NAME_SPACE: local

      - name: "NTLM Headerinfo - Verify allowed_domainlist error"
        run: |
          cd examples/Docker
          docker compose logs | grep -iE 'FQDN/SAN [^ ]+ not allowed by configuration'

      - name: "NTLM ACME Profiling - Setup a2c with mscertsrv_ca_handler"
        run: |
          sudo touch examples/Docker/data/acme_srv.cfg
          sudo chmod 777 examples/Docker/data/acme_srv.cfg
          sudo head -n -8 .github/openssl_ca_handler.py_acme_srv_default_handler.cfg > examples/Docker/data/acme_srv.cfg
          sudo echo "handler_file: examples/ca_handler/mscertsrv_ca_handler.py" >> examples/Docker/data/acme_srv.cfg
          sudo echo "host: $MSCA_FQDN" >> examples/Docker/data/acme_srv.cfg
          sudo echo "user: $MSCA_USER" >> examples/Docker/data/acme_srv.cfg
          sudo echo "password: $MSCA_PASSWORD" >> examples/Docker/data/acme_srv.cfg
          sudo echo "auth_method: ntlm" >> examples/Docker/data/acme_srv.cfg
          sudo echo "template: $MSCA_TEMPLATE" >> examples/Docker/data/acme_srv.cfg
          sudo echo "ca_bundle: /var/www/acme2certifier/volume/ca_certs.pem" >> examples/Docker/data/acme_srv.cfg
          sudo echo "verify: False" >> examples/Docker/data/acme_srv.cfg
          sudo echo "request_timeout: 30" >> examples/Docker/data/acme_srv.cfg
          sudo echo "enrollment_config_log: True" >> examples/Docker/data/acme_srv.cfg
          sudo sed -i "s/tnauthlist_support: False/tnauthlist_support: False\nprofiles={\"WebServerModified\": \"http:\/\/foo.bar\/acmeca1\", \"WebServer\": \"http:\/\/foo.bar\/acmeca2\", \"profile3\": \"http:\/\/foo.bar\/profile3\"}/g" examples/Docker/data/acme_srv.cfg
          sudo sed -i "s/revocation_reason_check_disable: False/revocation_reason_check_disable: False\nenrollment_timeout: 40/g" examples/Docker/data/acme_srv.cfg

      - name: "NTLM ACME Profiling - Enrollment"
        uses: ./.github/actions/wf_specific/ms_ca_handler/enroll_acmeprofile
        with:
          NAME_SPACE: local
          DEPLOYMENT_TYPE: container

      - name: "[ * ] collecting test logs"
        if: ${{ failure() }}
        run: |
          mkdir -p ${{ github.workspace }}/artifact/upload
          sudo cp -rp examples/Docker/data/ ${{ github.workspace }}/artifact/data/
          sudo cp /etc/hosts ${{ github.workspace }}/artifact/data/
          sudo cp /etc/resolv.conf ${{ github.workspace }}/artifact/data/
          cd examples/Docker
          docker compose logs > ${{ github.workspace }}/artifact/docker-compose.log
          sudo tar -C ${{ github.workspace }}/artifact/ -cvzf ${{ github.workspace }}/artifact/upload/artifact.tar.gz docker-compose.log data dnsmasq

      - name: "[ * ] uploading artificates"
        uses: actions/upload-artifact@v4
        if: ${{ failure() }}
        with:
          name: mscertsrv-container-tests-${{ matrix.websrv }}-${{ matrix.dbhandler }}.tar.gz
          path: ${{ github.workspace }}/artifact/upload/

  # ----------------------------------------------------------------------
  # Test mscertserv eab-profiling - container images (matrix from payload)
  # ----------------------------------------------------------------------
  mscertsrv-eabprov-container-tests:
    name: "mscertsrv-container-eab-profiling-tests"
    runs-on: ubuntu-latest
    # Prevent workflows from running in forks
    if: github.repository == 'grindsa/acme2certifier1'
    needs: [guard, mscertserv-test-containers]
    strategy:
      fail-fast: false
      # max-parallel: 1
      matrix:
        websrv: ['apache2', 'nginx']
        dbhandler: ['wsgi', 'django']
    steps:

      - name: "checkout GIT"
        uses: actions/checkout@v4

      - name: "Parse MSCA_CFG secrets"
        uses: ./.github/actions/parse-json-secret
        with:
          json_secret: ${{ secrets.MSCA_CFG }}

      - name: "Parse GH_CFG secrets"
        uses: ./.github/actions/parse-json-secret
        with:
          json_secret: ${{ secrets.GH_CFG }}

      - name: "Parse SSH_TUNNEL_CFG secrets"
        uses: ./.github/actions/parse-json-secret
        with:
          json_secret: ${{ secrets.SSH_TUNNEL_CFG }}

      - name: "Download and import container"
        uses: ./.github/actions/container_load
        with:
          RUN_ID: ${{ inputs.run_id }}
          ARTIFACT_NAME: a2c-${{ inputs.run_id }}.${{ matrix.websrv }}.${{ matrix.dbhandler }}.tar
          DESTINATION_PATH: /tmp
          TOKEN: ${{ secrets.GH_WF_TOKEN }}
          REPO: ${{ github.repository }}

      - name: "Prepare container environment"
        uses: ./.github/actions/container_prep
        with:
          DB_HANDLER: ${{ matrix.dbhandler }}
          WEB_SRV: ${{ matrix.websrv }}
          CONTAINER_BUILD: false
          NAME_SPACE: local

      - name: "Get runner ip"
        run: |
          echo RUNNER_IP=$(ip addr show eth0 | grep -i "inet " | cut -d ' ' -f 6 | cut -d '/' -f 1) >> $GITHUB_ENV
          echo RUNNER_PATH=$(pwd | sed 's_/_\\/_g') >> $GITHUB_ENV

      - run: echo "runner IP is $RUNNER_IP"
        env:
          RUNNER_IP: ${{ env.RUNNER_IP }}

      - name: "Setup tunnel"
        uses: ./.github/actions/wf_specific/ms_ca_handler/tunnel_setup
        with:
          SSH_USER: ${{ env.SSH_USER }}
          SSH_HOST: ${{ env.SSH_HOST }}
          SSH_PORT: ${{ env.SSH_PORT }}
          MSCA_IP: ${{ env.MSCA_IP }}
          MSCA_FQDN_WOTLD: ${{ env.MSCA_FQDN_WOTLD }}
          MSCA_FQDN: ${{ env.MSCA_FQDN }}
          SSH_KNOWN_HOSTS: ${{ env.SSH_KNOWN_HOSTS }}
          SSH_KEY: ${{ env.SSH_KEY }}
          NAME_SPACE: local

      - name: "EAB with headerinfo - Setup a2c with mscertsrv_ca_handler using kerberos"
        run: |
          sudo touch examples/Docker/data/ca_certs.pem
          sudo chmod 777 examples/Docker/data/ca_certs.pem
          sudo cp test/ca/certsrv_ca_certs.pem examples/Docker/data/ca_certs.pem
          sudo touch examples/Docker/data/acme_srv.cfg
          sudo chmod 777 examples/Docker/data/acme_srv.cfg
          sudo head -n -8 .github/openssl_ca_handler.py_acme_srv_default_handler.cfg > examples/Docker/data/acme_srv.cfg
          sudo echo "handler_file: examples/ca_handler/mscertsrv_ca_handler.py" >> examples/Docker/data/acme_srv.cfg
          sudo echo "host: $MSCA_FQDN" >> examples/Docker/data/acme_srv.cfg
          sudo echo "user: $MSCA_USER" >> examples/Docker/data/acme_srv.cfg
          sudo echo "password: $MSCA_PASSWORD" >> examples/Docker/data/acme_srv.cfg
          sudo echo "auth_method: gssapi" >> examples/Docker/data/acme_srv.cfg
          sudo echo "template: $MSCA_TEMPLATE" >> examples/Docker/data/acme_srv.cfg
          sudo echo "ca_bundle: /var/www/acme2certifier/volume/ca_certs.pem" >> examples/Docker/data/acme_srv.cfg
          sudo echo "krb5_config: /var/www/acme2certifier/volume/krb5.conf" >> examples/Docker/data/acme_srv.cfg
          sudo echo "verify: False" >> examples/Docker/data/acme_srv.cfg
          sudo echo "request_timeout: 30" >> examples/Docker/data/acme_srv.cfg
          sudo sed -i "s/tnauthlist_support: False/tnauthlist_support: False\nheader_info_list: [\"HTTP_USER_AGENT\"]/g" examples/Docker/data/acme_srv.cfg
          sudo sed -i "s/revocation_reason_check_disable: False/revocation_reason_check_disable: False\nenrollment_timeout: 40/g" examples/Docker/data/acme_srv.cfg

          sudo echo -e "\n\n[EABhandler]" >> examples/Docker/data/acme_srv.cfg
          sudo echo "eab_handler_file: /var/www/acme2certifier/examples/eab_handler/kid_profile_handler.py" >> examples/Docker/data/acme_srv.cfg
          sudo echo "key_file: volume/kid_profiles.json" >> examples/Docker/data/acme_srv.cfg
          sudo echo "eab_profiling: True" >> examples/Docker/data/acme_srv.cfg

          sudo touch examples/Docker/data/krb5.conf
          sudo chmod 777 examples/Docker/data/krb5.conf
          cat <<EOF > examples/Docker/data/krb5.conf
          $KRB5_CONF
          EOF

          sudo cp examples/eab_handler/kid_profiles.json examples/Docker/data/kid_profiles.json
          sudo sed -i '29,33d' examples/Docker/data/kid_profiles.json
          sudo sed -i '20,22d' examples/Docker/data/kid_profiles.json
          sudo chmod 777 examples/eab_handler/kid_profiles.json
          sudo sed -i "s/\"profile_id\"\: \[\"profile_1\", \"profile_2\", \"profile_3\"\]/\"template\"\: \[\"WebServerModified\"\, \"WebServer\"]/g" examples/Docker/data/kid_profiles.json
          sudo sed -i "s/\"profile_id\"\: \"profile_2\"/\"template\"\: \"WebServerModified\"/g" examples/Docker/data/kid_profiles.json
          sudo sed -i "s/\"ca_name\": \"example_ca_2\",/\"unknown_key\": \"unknown_value\"/g" examples/Docker/data/kid_profiles.json
          sudo sed -i "s/\"ca_name\": \"example_ca\",/\"unknown_key\": \"unknown_value\"/g" examples/Docker/data/kid_profiles.json
          sudo sed -i "s/example.net/local/g" examples/Docker/data/kid_profiles.json
          sudo sed -i '18,19d' examples/Docker/data/kid_profiles.json
          sudo sed -i '8,9d' examples/Docker/data/kid_profiles.json

      - name: "Bring up a2c container"
        uses: ./.github/actions/container_up
        with:
          DB_HANDLER: ${{ matrix.dbhandler }}
          WEB_SRV: ${{ matrix.websrv }}
          NAME_SPACE: local

      - name: "EAB with headerinfo - enrollment"
        uses: ./.github/actions/wf_specific/ms_ca_handler/enroll_eab
        with:
          NAME_SPACE: local

      - name: "Check container configuration"
        uses: ./.github/actions/container_check
        with:
          DB_HANDLER: ${{ matrix.dbhandler }}
          WEB_SRV: ${{ matrix.websrv }}

      - name: "EAB ACME Profiling - Setup a2c with ms_wcce_ca_handler (Kerboros)"
        run: |
          sudo touch examples/Docker/data/ca_certs.pem
          sudo chmod 777 examples/Docker/data/ca_certs.pem
          sudo cp test/ca/certsrv_ca_certs.pem examples/Docker/data/ca_certs.pem
          sudo touch examples/Docker/data/acme_srv.cfg
          sudo chmod 777 examples/Docker/data/acme_srv.cfg
          sudo head -n -8 .github/openssl_ca_handler.py_acme_srv_default_handler.cfg > examples/Docker/data/acme_srv.cfg
          sudo echo "handler_file: examples/ca_handler/mscertsrv_ca_handler.py" >> examples/Docker/data/acme_srv.cfg
          sudo echo "host: $MSCA_FQDN" >> examples/Docker/data/acme_srv.cfg
          sudo echo "user: $MSCA_USER" >> examples/Docker/data/acme_srv.cfg
          sudo echo "password: $MSCA_PASSWORD" >> examples/Docker/data/acme_srv.cfg
          sudo echo "auth_method: gssapi" >> examples/Docker/data/acme_srv.cfg
          sudo echo "template: $MSCA_TEMPLATE" >> examples/Docker/data/acme_srv.cfg
          sudo echo "ca_bundle: /var/www/acme2certifier/volume/ca_certs.pem" >> examples/Docker/data/acme_srv.cfg
          sudo echo "krb5_config: /var/www/acme2certifier/volume/krb5.conf" >> examples/Docker/data/acme_srv.cfg
          sudo echo "verify: False" >> examples/Docker/data/acme_srv.cfg
          sudo echo "request_timeout: 30" >> examples/Docker/data/acme_srv.cfg
          sudo echo "enrollment_config_log: True" >> examples/Docker/data/acme_srv.cfg
          sudo sed -i "s/tnauthlist_support: False/tnauthlist_support: False\nprofiles={\"WebServerModified\": \"http:\/\/foo.bar\/profile1\", \"WebServer\": \"http:\/\/foo.bar\/profile2\", \"profile3\": \"http:\/\/foo.bar\/profile3\"}/g" examples/Docker/data/acme_srv.cfg
          sudo sed -i "s/revocation_reason_check_disable: False/revocation_reason_check_disable: False\nenrollment_timeout: 40/g" examples/Docker/data/acme_srv.cfg

          sudo echo -e "\n\n[EABhandler]" >> examples/Docker/data/acme_srv.cfg
          sudo echo "eab_handler_file: /var/www/acme2certifier/examples/eab_handler/kid_profile_handler.py" >> examples/Docker/data/acme_srv.cfg
          sudo echo "key_file: volume/kid_profiles.json" >> examples/Docker/data/acme_srv.cfg
          sudo echo "eab_profiling: True" >> examples/Docker/data/acme_srv.cfg

          sudo touch examples/Docker/data/krb5.conf
          sudo chmod 777 examples/Docker/data/krb5.conf
          cat <<EOF > examples/Docker/data/krb5.conf
          $KRB5_CONF
          EOF

          sudo cp examples/eab_handler/kid_profiles.json examples/Docker/data/kid_profiles.json
          sudo sed -i '29,33d' examples/Docker/data/kid_profiles.json
          sudo sed -i '20,22d' examples/Docker/data/kid_profiles.json
          sudo chmod 777 examples/eab_handler/kid_profiles.json
          sudo sed -i "s/\"profile_id\"\: \[\"profile_1\", \"profile_2\", \"profile_3\"\]/\"template\"\: \[\"WebServerModified\"\, \"WebServer\"]/g" examples/Docker/data/kid_profiles.json
          sudo sed -i "s/\"profile_id\"\: \"profile_2\"/\"template\"\: \"WebServerModified\"/g" examples/Docker/data/kid_profiles.json
          sudo sed -i "s/\"ca_name\": \"example_ca_2\",/\"unknown_key\": \"unknown_value\"/g" examples/Docker/data/kid_profiles.json
          sudo sed -i "s/\"ca_name\": \"example_ca\",/\"unknown_key\": \"unknown_value\"/g" examples/Docker/data/kid_profiles.json
          sudo sed -i "s/example.net/local/g" examples/Docker/data/kid_profiles.json
          sudo sed -i '18,19d' examples/Docker/data/kid_profiles.json
          sudo sed -i '8,9d' examples/Docker/data/kid_profiles.json
          cd examples/Docker/
          docker compose restart

      - name: "EAB ACME Profiling - Enrollment"
        uses: ./.github/actions/wf_specific/ms_ca_handler/enroll_eab_acmeprofile
        with:
          NAME_SPACE: local
          DEPLOYMENT_TYPE: container

      - name: "[ * ] collecting test logs"
        if: ${{ failure() }}
        run: |
          mkdir -p ${{ github.workspace }}/artifact/upload
          sudo cp -rp examples/Docker/data/ ${{ github.workspace }}/artifact/data/
          sudo cp /etc/hosts ${{ github.workspace }}/artifact/data/
          sudo cp /etc/resolv.conf ${{ github.workspace }}/artifact/data/
            cd examples/Docker
          docker compose logs > ${{ github.workspace }}/artifact/docker-compose.log
          sudo tar -C ${{ github.workspace }}/artifact/ -cvzf ${{ github.workspace }}/artifact/upload/artifact.tar.gz docker-compose.log data dnsmasq

      - name: "[ * ] uploading artificates"
        uses: actions/upload-artifact@v4
        if: ${{ failure() }}
        with:
          name: mscertsrv-eabp-container-tests-${{ matrix.websrv }}-${{ matrix.dbhandler }}.tar.gz
          path: ${{ github.workspace }}/artifact/upload/

  # ---------------------------------------------------------
  # Test mswcce - container images (matrix from payload)
  # ---------------------------------------------------------
  mswcce-test-containers:
    runs-on: ubuntu-latest
    needs: guard
    # Prevent workflows from running in forks
    if: github.repository == 'grindsa/acme2certifier1'
    strategy:
      fail-fast: false
      # max-parallel: 1
      matrix:
        websrv: ['apache2', 'nginx']
        dbhandler: ['wsgi', 'django']
    steps:
      - name: "checkout GIT"
        uses: actions/checkout@v4

      - name: "Parse MSCA_CFG secrets"
        uses: ./.github/actions/parse-json-secret
        with:
          json_secret: ${{ secrets.MSCA_CFG }}

      - name: "Parse GH_CFG secrets"
        uses: ./.github/actions/parse-json-secret
        with:
          json_secret: ${{ secrets.GH_CFG }}

      - name: "Parse SSH_TUNNEL_CFG secrets"
        uses: ./.github/actions/parse-json-secret
        with:
          json_secret: ${{ secrets.SSH_TUNNEL_CFG }}

      - name: "Download and import container"
        uses: ./.github/actions/container_load
        with:
          RUN_ID: ${{ inputs.run_id }}
          ARTIFACT_NAME: a2c-${{ inputs.run_id }}.${{ matrix.websrv }}.${{ matrix.dbhandler }}.tar
          DESTINATION_PATH: /tmp
          TOKEN: ${{ secrets.GH_WF_TOKEN }}
          REPO: ${{ github.repository }}

      - name: "Prepare container environment"
        uses: ./.github/actions/container_prep
        with:
          DB_HANDLER: ${{ matrix.dbhandler }}
          WEB_SRV: ${{ matrix.websrv }}
          CONTAINER_BUILD: false
          NAME_SPACE: acme

      - name: "[ PREPARE ] get runner ip"
        run: |
          echo RUNNER_IP=$(ip addr show eth0 | grep -i "inet " | cut -d ' ' -f 6 | cut -d '/' -f 1) >> $GITHUB_ENV
          echo RUNNER_PATH=$(pwd | sed 's_/_\\/_g') >> $GITHUB_ENV

      - run: echo "runner IP is $RUNNER_IP"
        env:
          RUNNER_IP: ${{ env.RUNNER_IP }}

      - name: "Install dnsmasq"
        run: |
          sudo apt-get update
          sudo apt-get install -y dnsmasq
          sudo systemctl disable systemd-resolved
          sudo systemctl stop systemd-resolved
          sudo mkdir -p dnsmasq
          sudo cp .github/dnsmasq.conf dnsmasq/
          sudo chmod -R 777 dnsmasq/dnsmasq.conf
          sudo sed -i "s/RUNNER_IP/$RUNNER_IP/g" dnsmasq/dnsmasq.conf
          sudo echo "address=/$MSCA_FQDN/$RUNNER_IP" >> dnsmasq/dnsmasq.conf
          sudo echo "address=/$MSCA_ADS_DOMAIN/$RUNNER_IP" >> dnsmasq/dnsmasq.conf
          sudo echo "address=/$WES_HOST/$RUNNER_IP" >> dnsmasq/dnsmasq.conf
          cat dnsmasq/dnsmasq.conf
          sudo cp dnsmasq/dnsmasq.conf /etc/
          sudo systemctl enable dnsmasq
          sudo systemctl start dnsmasq

      - name: "[ PREPARE ] test dns resulution"
        run: |
          host $MSCA_ADS_DOMAIN 127.0.0.1
          host $MSCA_FQDN 127.0.0.1
          host $WES_HOST 127.0.0.1

      - name: "Setup tunnel"
        uses: ./.github/actions/wf_specific/ms_ca_handler/tunnel_setup
        with:
          SSH_USER: ${{ env.SSH_USER }}
          SSH_HOST: ${{ env.SSH_HOST }}
          SSH_PORT: ${{ env.SSH_PORT }}
          MSCA_IP: ${{ env.MSCA_IP }}
          MSCA_FQDN_WOTLD: ${{ env.MSCA_FQDN_WOTLD }}
          MSCA_FQDN: ${{ env.MSCA_FQDN }}
          SSH_KNOWN_HOSTS: ${{ env.SSH_KNOWN_HOSTS }}
          SSH_KEY: ${{ env.SSH_KEY }}

      - name: "NTLM Headerinfo - Setup a2c with ms_wcce_ca_handler"
        run: |
          sudo cp .github/django_settings.py examples/Docker/data/settings.py
          sudo touch examples/Docker/data/ca_certs.pem
          sudo chmod 777 examples/Docker/data/ca_certs.pem
          sudo echo "$MSCA_CA_BUNDLE" > examples/Docker/data/ca_certs.pem
          sudo touch examples/Docker/data/acme_srv.cfg
          sudo chmod 777 examples/Docker/data/acme_srv.cfg
          sudo head -n -8 .github/openssl_ca_handler.py_acme_srv_default_handler.cfg > examples/Docker/data/acme_srv.cfg
          sudo echo "handler_file: /var/www/acme2certifier/examples/ca_handler/mswcce_ca_handler.py" >> examples/Docker/data/acme_srv.cfg
          sudo echo "host: $RUNNER_IP" >> examples/Docker/data/acme_srv.cfg
          sudo echo "user: $MSCA_USER" >> examples/Docker/data/acme_srv.cfg
          sudo echo "password: $MSCA_PASSWORD" >> examples/Docker/data/acme_srv.cfg
          sudo echo "template: $MSCA_TEMPLATE" >> examples/Docker/data/acme_srv.cfg
          sudo echo "ca_name: $MSCA_NAME" >> examples/Docker/data/acme_srv.cfg
          sudo echo "target_domain: $MSCA_ADS_DOMAIN" >> examples/Docker/data/acme_srv.cfg
          sudo echo "ca_bundle: volume/ca_certs.pem" >> examples/Docker/data/acme_srv.cfg
          sudo echo "timeout: 20" >> examples/Docker/data/acme_srv.cfg
          sudo echo "ssh_host: $SSH_HOST:$SSH_PORT" >> examples/Docker/data/acme_srv.cfg
          sudo sed -i "s/tnauthlist_support: False/tnauthlist_support: False\nheader_info_list: [\"HTTP_USER_AGENT\"]/g" examples/Docker/data/acme_srv.cfg
          sudo sed -i "s/revocation_reason_check_disable: False/revocation_reason_check_disable: False\nenrollment_timeout: 40/g" examples/Docker/data/acme_srv.cfg

      - name: "NTLM Headerinfo - Bring up a2c container"
        uses: ./.github/actions/container_up
        with:
          DB_HANDLER: ${{ matrix.dbhandler }}
          WEB_SRV: ${{ matrix.websrv }}

      - name: "NTLM Headerinfo  - Enrollment"
        uses: ./.github/actions/wf_specific/ms_ca_handler/enroll_default_headerinfo

      - name: "Check container configuration"
        uses: ./.github/actions/container_check
        with:
          DB_HANDLER: ${{ matrix.dbhandler }}
          WEB_SRV: ${{ matrix.websrv }}

      - name: "NTLM ACME Profile - Setup a2c with ms_wcce_ca_handler"
        run: |
          sudo touch examples/Docker/data/ca_certs.pem
          sudo chmod 777 examples/Docker/data/ca_certs.pem
          sudo echo "$MSCA_CA_BUNDLE" > examples/Docker/data/ca_certs.pem
          sudo touch examples/Docker/data/acme_srv.cfg
          sudo chmod 777 examples/Docker/data/acme_srv.cfg
          sudo head -n -8 .github/openssl_ca_handler.py_acme_srv_default_handler.cfg > examples/Docker/data/acme_srv.cfg
          sudo echo "handler_file: /var/www/acme2certifier/examples/ca_handler/mswcce_ca_handler.py" >> examples/Docker/data/acme_srv.cfg
          sudo echo "host: $RUNNER_IP" >> examples/Docker/data/acme_srv.cfg
          sudo echo "user: $MSCA_USER" >> examples/Docker/data/acme_srv.cfg
          sudo echo "password: $MSCA_PASSWORD" >> examples/Docker/data/acme_srv.cfg
          sudo echo "template: $MSCA_TEMPLATE" >> examples/Docker/data/acme_srv.cfg
          sudo echo "ca_name: $MSCA_NAME" >> examples/Docker/data/acme_srv.cfg
          sudo echo "target_domain: $MSCA_ADS_DOMAIN" >> examples/Docker/data/acme_srv.cfg
          sudo echo "ca_bundle: volume/ca_certs.pem" >> examples/Docker/data/acme_srv.cfg
          sudo echo "timeout: 20" >> examples/Docker/data/acme_srv.cfg
          sudo echo "ssh_host: $SSH_HOST:$SSH_PORT" >> examples/Docker/data/acme_srv.cfg
          sudo echo "enrollment_config_log: True" >> examples/Docker/data/acme_srv.cfg
          sudo sed -i "s/tnauthlist_support: False/tnauthlist_support: False\nprofiles={\"WebServerModified\": \"http:\/\/foo.bar\/acmeca1\", \"WebServer\": \"http:\/\/foo.bar\/acmeca2\", \"profile3\": \"http:\/\/foo.bar\/profile3\"}/g" examples/Docker/data/acme_srv.cfg
          sudo sed -i "s/revocation_reason_check_disable: False/revocation_reason_check_disable: False\nenrollment_timeout: 40/g" examples/Docker/data/acme_srv.cfg
          cd examples/Docker/
          docker compose restart

      - name: "NTLM ACME Profiling - Enrollment"
        uses: ./.github/actions/wf_specific/ms_ca_handler/enroll_acmeprofile
        with:
          DEPLOYMENT_TYPE: container

      - name: "KRB Headerinfo - Setup a2c with ms_wcce_ca_handler"
        run: |
          sudo touch examples/Docker/data/ca_certs.pem
          sudo chmod 777 examples/Docker/data/ca_certs.pem
          sudo echo "$MSCA_CA_BUNDLE" > examples/Docker/data/ca_certs.pem
          sudo touch examples/Docker/data/acme_srv.cfg
          sudo chmod 777 examples/Docker/data/acme_srv.cfg
          sudo head -n -8 .github/openssl_ca_handler.py_acme_srv_default_handler.cfg > examples/Docker/data/acme_srv.cfg
          sudo echo "handler_file: /var/www/acme2certifier/examples/ca_handler/mswcce_ca_handler.py" >> examples/Docker/data/acme_srv.cfg
          sudo echo "host: $MSCA_FQDN" >> examples/Docker/data/acme_srv.cfg
          sudo echo "user: $MSCA_USER" >> examples/Docker/data/acme_srv.cfg
          sudo echo "password: $MSCA_PASSWORD" >> examples/Docker/data/acme_srv.cfg
          sudo echo "template: $MSCA_TEMPLATE" >> examples/Docker/data/acme_srv.cfg
          sudo echo "ca_name: $MSCA_NAME" >> examples/Docker/data/acme_srv.cfg
          sudo echo "target_domain: $MSCA_ADS_DOMAIN" >> examples/Docker/data/acme_srv.cfg
          sudo echo "domain_controller: $RUNNER_IP" >> examples/Docker/data/acme_srv.cfg
          sudo echo "ca_bundle: volume/ca_certs.pem" >> examples/Docker/data/acme_srv.cfg
          sudo echo "timeout: 20" >> examples/Docker/data/acme_srv.cfg
          sudo echo "use_kerberos: True" >> examples/Docker/data/acme_srv.cfg
          sudo sed -i "s/tnauthlist_support: False/tnauthlist_support: False\nheader_info_list: [\"HTTP_USER_AGENT\"]/g" examples/Docker/data/acme_srv.cfg
          sudo sed -i "s/revocation_reason_check_disable: False/revocation_reason_check_disable: False\nenrollment_timeout: 40/g" examples/Docker/data/acme_srv.cfg
          cd examples/Docker/
          docker compose restart

      - name: "KRB Headerinfo - Sleep for 10s"
        uses: juliangruber/sleep-action@v2.0.3
        with:
          time: 10s

      - name: "KRB Headerinfo - Enrollment"
        uses: ./.github/actions/wf_specific/ms_ca_handler/enroll_default_headerinfo

      - name: "KRB - Setup a2c with mswcce_ca_handler with allowed_domainlist configuration"
        run: |
          sudo sed -i "s/challenge_validation_disable: False/challenge_validation_disable: True/g" examples/Docker/data/acme_srv.cfg
          sudo echo "allowed_domainlist: [\"*.acme\", \"foo1.bar\", \"*.bar.local\"]" >> examples/Docker/data/acme_srv.cfg
          cd examples/Docker/
          docker compose restart

      - name: "KRB - enrollment allowed domainlist"
        uses: ./.github/actions/wf_specific/ms_ca_handler/enroll_allowed_domain_list

      - name: "Verify allowed_domainlist error"
        run: |
          cd examples/Docker
          docker compose logs | grep -iE 'FQDN/SAN [^ ]+ not allowed by configuration'

      - name: "KRB ACME Profile - Setup a2c with ms_wcce_ca_handler"
        run: |
          sudo touch examples/Docker/data/ca_certs.pem
          sudo chmod 777 examples/Docker/data/ca_certs.pem
          sudo echo "$MSCA_CA_BUNDLE" > examples/Docker/data/ca_certs.pem
          sudo touch examples/Docker/data/acme_srv.cfg
          sudo chmod 777 examples/Docker/data/acme_srv.cfg
          sudo head -n -8 .github/openssl_ca_handler.py_acme_srv_default_handler.cfg > examples/Docker/data/acme_srv.cfg
          sudo echo "handler_file: /var/www/acme2certifier/examples/ca_handler/mswcce_ca_handler.py" >> examples/Docker/data/acme_srv.cfg
          sudo echo "host: $MSCA_FQDN" >> examples/Docker/data/acme_srv.cfg
          sudo echo "user: $MSCA_USER" >> examples/Docker/data/acme_srv.cfg
          sudo echo "password: $MSCA_PASSWORD" >> examples/Docker/data/acme_srv.cfg
          sudo echo "template: $MSCA_TEMPLATE" >> examples/Docker/data/acme_srv.cfg
          sudo echo "ca_name: $MSCA_NAME" >> examples/Docker/data/acme_srv.cfg
          sudo echo "target_domain: $MSCA_ADS_DOMAIN" >> examples/Docker/data/acme_srv.cfg
          sudo echo "domain_controller: $RUNNER_IP" >> examples/Docker/data/acme_srv.cfg
          sudo echo "ca_bundle: volume/ca_certs.pem" >> examples/Docker/data/acme_srv.cfg
          sudo echo "timeout: 20" >> examples/Docker/data/acme_srv.cfg
          sudo echo "use_kerberos: True" >> examples/Docker/data/acme_srv.cfg
          sudo echo "enrollment_config_log: True" >> examples/Docker/data/acme_srv.cfg
          sudo sed -i "s/tnauthlist_support: False/tnauthlist_support: False\nprofiles={\"WebServerModified\": \"http:\/\/foo.bar\/acmeca1\", \"WebServer\": \"http:\/\/foo.bar\/acmeca2\", \"profile3\": \"http:\/\/foo.bar\/profile3\"}/g" examples/Docker/data/acme_srv.cfg
          sudo sed -i "s/revocation_reason_check_disable: False/revocation_reason_check_disable: False\nenrollment_timeout: 40/g" examples/Docker/data/acme_srv.cfg
          cd examples/Docker/
          docker compose restart

      - name: "KRB ACME Profile - Sleep for 10s"
        uses: juliangruber/sleep-action@v2.0.3
        with:
          time: 10s

      - name: "KRB ACME Profile - Enrollment"
        uses: ./.github/actions/wf_specific/ms_ca_handler/enroll_acmeprofile
        with:
          DEPLOYMENT_TYPE: container

      - name: "[ * ] collecting test logs"
        if: ${{ failure() }}
        run: |
          mkdir -p ${{ github.workspace }}/artifact/upload
          sudo cp -rp examples/Docker/data/ ${{ github.workspace }}/artifact/data/
          sudo cp -rp dnsmasq/ ${{ github.workspace }}/artifact/dnsmasq/
          cd examples/Docker
          docker compose logs > ${{ github.workspace }}/artifact/docker-compose.log
          sudo tar -C ${{ github.workspace }}/artifact/ -cvzf ${{ github.workspace }}/artifact/upload/artifact.tar.gz docker-compose.log data dnsmasq
      - name: "[ * ] uploading artificates"
        uses: actions/upload-artifact@v4
        if: ${{ failure() }}
        with:
          name: mswcce-container-tests-${{ matrix.websrv }}-${{ matrix.dbhandler }}.tar.gz
          path: ${{ github.workspace }}/artifact/upload/

  # ---------------------------------------------------------
  # Test mswcce eab - container images (matrix from payload)
  # ---------------------------------------------------------
  mswcce-eab-container-tests:
    runs-on: ubuntu-latest
    # Prevent workflows from running in forks
    if: github.repository == 'grindsa/acme2certifier1'
    needs: [guard, mswcce-test-containers]
    strategy:
      fail-fast: false
      # max-parallel: 2
      matrix:
        websrv: ['apache2', 'nginx']
        dbhandler: ['wsgi', 'django']

    steps:
      - name: "checkout GIT"
        uses: actions/checkout@v4

      - name: "Parse MSCA_CFG secrets"
        uses: ./.github/actions/parse-json-secret
        with:
          json_secret: ${{ secrets.MSCA_CFG }}

      - name: "Parse GH_CFG secrets"
        uses: ./.github/actions/parse-json-secret
        with:
          json_secret: ${{ secrets.GH_CFG }}

      - name: "Parse SSH_TUNNEL_CFG secrets"
        uses: ./.github/actions/parse-json-secret
        with:
          json_secret: ${{ secrets.SSH_TUNNEL_CFG }}

      - name: "[ PREPARE ] get runner ip"
        run: |
          echo RUNNER_IP=$(ip addr show eth0 | grep -i "inet " | cut -d ' ' -f 6 | cut -d '/' -f 1) >> $GITHUB_ENV
          echo RUNNER_PATH=$(pwd | sed 's_/_\\/_g') >> $GITHUB_ENV

      - run: echo "runner IP is $RUNNER_IP"
        env:
          RUNNER_IP: ${{ env.RUNNER_IP }}

      - name: "Install dnsmasq"
        run: |
          sudo apt-get update
          sudo apt-get install -y dnsmasq
          sudo systemctl disable systemd-resolved
          sudo systemctl stop systemd-resolved
          sudo mkdir -p dnsmasq
          sudo cp .github/dnsmasq.conf dnsmasq/
          sudo chmod -R 777 dnsmasq/dnsmasq.conf
          sudo sed -i "s/RUNNER_IP/$RUNNER_IP/g" dnsmasq/dnsmasq.conf
          sudo echo "address=/$MSCA_FQDN/$RUNNER_IP" >> dnsmasq/dnsmasq.conf
          sudo echo "address=/$MSCA_ADS_DOMAIN/$RUNNER_IP" >> dnsmasq/dnsmasq.conf
          sudo echo "address=/$WES_HOST/$RUNNER_IP" >> dnsmasq/dnsmasq.conf
          cat dnsmasq/dnsmasq.conf
          sudo cp dnsmasq/dnsmasq.conf /etc/
          sudo systemctl enable dnsmasq
          sudo systemctl start dnsmasq

      - name: "[ PREPARE ] test dns resulution"
        run: |
          host $MSCA_ADS_DOMAIN 127.0.0.1
          host $MSCA_FQDN 127.0.0.1
          host $WES_HOST 127.0.0.1

      - name: "Download and import container"
        uses: ./.github/actions/container_load
        with:
          RUN_ID: ${{ inputs.run_id }}
          ARTIFACT_NAME: a2c-${{ inputs.run_id }}.${{ matrix.websrv }}.${{ matrix.dbhandler }}.tar
          DESTINATION_PATH: /tmp
          TOKEN: ${{ secrets.GH_WF_TOKEN }}
          REPO: ${{ github.repository }}

      - name: "Prepare container environment"
        uses: ./.github/actions/container_prep
        with:
          DB_HANDLER: ${{ matrix.dbhandler }}
          WEB_SRV: ${{ matrix.websrv }}
          CONTAINER_BUILD: false

      - name: "Setup tunnel"
        uses: ./.github/actions/wf_specific/ms_ca_handler/tunnel_setup
        with:
          SSH_USER: ${{ env.SSH_USER }}
          SSH_HOST: ${{ env.SSH_HOST }}
          SSH_PORT: ${{ env.SSH_PORT }}
          MSCA_IP: ${{ env.MSCA_IP }}
          MSCA_FQDN_WOTLD: ${{ env.MSCA_FQDN_WOTLD }}
          MSCA_FQDN: ${{ env.MSCA_FQDN }}
          SSH_KNOWN_HOSTS: ${{ env.SSH_KNOWN_HOSTS }}
          SSH_KEY: ${{ env.SSH_KEY }}

      - name: "EAB with headerinfo - Setup a2c with ms_wcce_ca_handler (Kerboros)"
        run: |
          sudo touch examples/Docker/data/ca_certs.pem
          sudo chmod 777 examples/Docker/data/ca_certs.pem
          sudo echo "$MSCA_CA_BUNDLE" > examples/Docker/data/ca_certs.pem
          sudo touch examples/Docker/data/acme_srv.cfg
          sudo chmod 777 examples/Docker/data/acme_srv.cfg
          sudo head -n -8 .github/openssl_ca_handler.py_acme_srv_default_handler.cfg > examples/Docker/data/acme_srv.cfg
          sudo echo "handler_file: /var/www/acme2certifier/examples/ca_handler/mswcce_ca_handler.py" >> examples/Docker/data/acme_srv.cfg
          sudo echo "host: $MSCA_FQDN" >> examples/Docker/data/acme_srv.cfg
          sudo echo "user: $MSCA_USER" >> examples/Docker/data/acme_srv.cfg
          sudo echo "password: $MSCA_PASSWORD" >> examples/Docker/data/acme_srv.cfg
          sudo echo "template: $MSCA_TEMPLATE" >> examples/Docker/data/acme_srv.cfg
          sudo echo "ca_name: $MSCA_NAME" >> examples/Docker/data/acme_srv.cfg
          sudo echo "target_domain: $MSCA_ADS_DOMAIN" >> examples/Docker/data/acme_srv.cfg
          sudo echo "domain_controller: $RUNNER_IP" >> examples/Docker/data/acme_srv.cfg
          sudo echo "ca_bundle: volume/ca_certs.pem" >> examples/Docker/data/acme_srv.cfg
          sudo echo "timeout: 20" >> examples/Docker/data/acme_srv.cfg
          sudo echo "use_kerberos: True" >> examples/Docker/data/acme_srv.cfg
          sudo sed -i "s/tnauthlist_support: False/tnauthlist_support: False\nheader_info_list: [\"HTTP_USER_AGENT\"]/g" examples/Docker/data/acme_srv.cfg
          sudo sed -i "s/revocation_reason_check_disable: False/revocation_reason_check_disable: False\nenrollment_timeout: 40/g" examples/Docker/data/acme_srv.cfg

          sudo echo -e "\n\n[EABhandler]" >> examples/Docker/data/acme_srv.cfg
          sudo echo "eab_handler_file: /var/www/acme2certifier/examples/eab_handler/kid_profile_handler.py" >> examples/Docker/data/acme_srv.cfg
          sudo echo "key_file: volume/kid_profiles.json" >> examples/Docker/data/acme_srv.cfg
          sudo echo "eab_profiling: True" >> examples/Docker/data/acme_srv.cfg

          sudo cp examples/eab_handler/kid_profiles.json examples/Docker/data/kid_profiles.json
          sudo sed -i '29,33d' examples/Docker/data/kid_profiles.json
          sudo sed -i '20,22d' examples/Docker/data/kid_profiles.json
          sudo chmod 777 examples/eab_handler/kid_profiles.json
          sudo sed -i "s/\"profile_id\"\: \[\"profile_1\", \"profile_2\", \"profile_3\"\]/\"template\"\: \[\"WebServerModified\"\, \"WebServer\"]/g" examples/Docker/data/kid_profiles.json
          sudo sed -i "s/\"profile_id\"\: \"profile_2\"/\"template\"\: \"WebServerModified\"/g" examples/Docker/data/kid_profiles.json
          sudo sed -i "s/\"ca_name\": \"example_ca_2\",/\"unknown_key\": \"unknown_value\"/g" examples/Docker/data/kid_profiles.json
          sudo sed -i "s/\"ca_name\": \"example_ca\",/\"unknown_key\": \"unknown_value\"/g" examples/Docker/data/kid_profiles.json
          sudo sed -i "s/example.net/acme/g" examples/Docker/data/kid_profiles.json
          sudo sed -i '18,19d' examples/Docker/data/kid_profiles.json
          sudo sed -i '8,9d' examples/Docker/data/kid_profiles.json

      - name: "Bring up a2c container"
        uses: ./.github/actions/container_up
        with:
          DB_HANDLER: ${{ matrix.dbhandler }}
          WEB_SRV: ${{ matrix.websrv }}

      - name: "EAB with headerinfo - enrollment"
        uses: ./.github/actions/wf_specific/ms_ca_handler/enroll_eab

      - name: "Check container configuration"
        uses: ./.github/actions/container_check
        with:
          DB_HANDLER: ${{ matrix.dbhandler }}
          WEB_SRV: ${{ matrix.websrv }}

      - name: "EAB ACME Profiling - Setup a2c with ms_wcce_ca_handler (Kerboros)"
        run: |
          sudo touch examples/Docker/data/ca_certs.pem
          sudo chmod 777 examples/Docker/data/ca_certs.pem
          sudo echo "$MSCA_CA_BUNDLE" > examples/Docker/data/ca_certs.pem
          sudo touch examples/Docker/data/acme_srv.cfg
          sudo chmod 777 examples/Docker/data/acme_srv.cfg
          sudo head -n -8 .github/openssl_ca_handler.py_acme_srv_default_handler.cfg > examples/Docker/data/acme_srv.cfg
          sudo echo "handler_file: /var/www/acme2certifier/examples/ca_handler/mswcce_ca_handler.py" >> examples/Docker/data/acme_srv.cfg
          sudo echo "host: $MSCA_FQDN" >> examples/Docker/data/acme_srv.cfg
          sudo echo "user: $MSCA_USER" >> examples/Docker/data/acme_srv.cfg
          sudo echo "password: $MSCA_PASSWORD" >> examples/Docker/data/acme_srv.cfg
          sudo echo "template: $MSCA_TEMPLATE" >> examples/Docker/data/acme_srv.cfg
          sudo echo "ca_name: $MSCA_NAME" >> examples/Docker/data/acme_srv.cfg
          sudo echo "target_domain: $MSCA_ADS_DOMAIN" >> examples/Docker/data/acme_srv.cfg
          sudo echo "domain_controller: $RUNNER_IP" >> examples/Docker/data/acme_srv.cfg
          sudo echo "ca_bundle: volume/ca_certs.pem" >> examples/Docker/data/acme_srv.cfg
          sudo echo "timeout: 20" >> examples/Docker/data/acme_srv.cfg
          sudo echo "use_kerberos: True" >> examples/Docker/data/acme_srv.cfg
          sudo echo "enrollment_config_log: True" >> examples/Docker/data/acme_srv.cfg
          sudo sed -i "s/tnauthlist_support: False/tnauthlist_support: False\nprofiles={\"WebServerModified\": \"http:\/\/foo.bar\/profile1\", \"WebServer\": \"http:\/\/foo.bar\/profile2\", \"profile3\": \"http:\/\/foo.bar\/profile3\"}/g" examples/Docker/data/acme_srv.cfg
          sudo sed -i "s/revocation_reason_check_disable: False/revocation_reason_check_disable: False\nenrollment_timeout: 40/g" examples/Docker/data/acme_srv.cfg

          sudo echo -e "\n\n[EABhandler]" >> examples/Docker/data/acme_srv.cfg
          sudo echo "eab_handler_file: /var/www/acme2certifier/examples/eab_handler/kid_profile_handler.py" >> examples/Docker/data/acme_srv.cfg
          sudo echo "key_file: volume/kid_profiles.json" >> examples/Docker/data/acme_srv.cfg
          sudo echo "eab_profiling: True" >> examples/Docker/data/acme_srv.cfg

          sudo cp examples/eab_handler/kid_profiles.json examples/Docker/data/kid_profiles.json
          sudo sed -i '29,33d' examples/Docker/data/kid_profiles.json
          sudo sed -i '20,22d' examples/Docker/data/kid_profiles.json
          sudo chmod 777 examples/eab_handler/kid_profiles.json
          sudo sed -i "s/\"profile_id\"\: \[\"profile_1\", \"profile_2\", \"profile_3\"\]/\"template\"\: \[\"WebServerModified\"\, \"WebServer\"]/g" examples/Docker/data/kid_profiles.json
          sudo sed -i "s/\"profile_id\"\: \"profile_2\"/\"template\"\: \"WebServerModified\"/g" examples/Docker/data/kid_profiles.json
          sudo sed -i "s/\"ca_name\": \"example_ca_2\",/\"unknown_key\": \"unknown_value\"/g" examples/Docker/data/kid_profiles.json
          sudo sed -i "s/\"ca_name\": \"example_ca\",/\"unknown_key\": \"unknown_value\"/g" examples/Docker/data/kid_profiles.json
          sudo sed -i "s/example.net/acme/g" examples/Docker/data/kid_profiles.json
          sudo sed -i '18,19d' examples/Docker/data/kid_profiles.json
          sudo sed -i '8,9d' examples/Docker/data/kid_profiles.json
          cd examples/Docker/
          docker compose restart

      - name: "EAB ACME Profiling - Enrollment"
        uses: ./.github/actions/wf_specific/ms_ca_handler/enroll_eab_acmeprofile
        with:
          DEPLOYMENT_TYPE: container

      - name: "[ * ] collecting test logs"
        if: ${{ failure() }}
        run: |
          mkdir -p ${{ github.workspace }}/artifact/upload
          sudo cp -rp examples/Docker/data/ ${{ github.workspace }}/artifact/data/
          sudo cp -rp dnsmasq/ ${{ github.workspace }}/artifact/dnsmasq/
          cd examples/Docker
          docker compose logs > ${{ github.workspace }}/artifact/docker-compose.log
          sudo tar -C ${{ github.workspace }}/artifact/ -cvzf ${{ github.workspace }}/artifact/upload/artifact.tar.gz docker-compose.log data dnsmasq

      - name: "[ * ] uploading artificates"
        uses: actions/upload-artifact@v4
        if: ${{ failure() }}
        with:
          name: mswcce-eabp-container-tests-${{ matrix.websrv }}-${{ matrix.dbhandler }}.tar.gz
          path: ${{ github.workspace }}/artifact/upload/

  # -------------------------------------------------------------------
  # Test mswcce eab - container images container build without impacket
  # -------------------------------------------------------------------
  mscertsrv-without-impacket_tests:
    name: "mscertsrv-without-impacket_tests"
    runs-on: ubuntu-latest
    needs: [guard, mswcce-eab-container-tests]
    # Prevent workflows from running in forks
    if: github.repository == 'grindsa/acme2certifier1'
    strategy:
      fail-fast: false
      # max-parallel: 1
      matrix:
        websrv: ['apache2', 'nginx']
        dbhandler: ['wsgi', 'django']
    steps:
      - name: "checkout GIT"
        uses: actions/checkout@v4

      - name: "Parse MSCA_CFG secrets"
        uses: ./.github/actions/parse-json-secret
        with:
          json_secret: ${{ secrets.MSCA_CFG }}

      - name: "Parse GH_CFG secrets"
        uses: ./.github/actions/parse-json-secret
        with:
          json_secret: ${{ secrets.GH_CFG }}

      - name: "Parse SSH_TUNNEL_CFG secrets"
        uses: ./.github/actions/parse-json-secret
        with:
          json_secret: ${{ secrets.SSH_TUNNEL_CFG }}

      - name: "Modify Dockerfile"
        run: |
          cd examples/Docker/$WEBSRV/$DBHANDLER
          sed -i '/RUN pip3 install impacket --break-system-packages && \\/d' Dockerfile
          sed -i '/rm \/usr\/local\/bin\/\*.py && \\/d' Dockerfile
          sed -i '/rm -rf \/usr\/local\/lib\/python3.12\/dist-packages\/impacket\/examples\/\* && \\/d' Dockerfile
          sed -i "s/    pip3 install -r/RUN pip3 install -r/g" Dockerfile
        env:
          WEBSRV: ${{ matrix.websrv }}
          DBHANDLER: ${{ matrix.dbhandler }}

      - name: "Build container"
        uses: ./.github/actions/container_prep
        with:
          DB_HANDLER: ${{ matrix.dbhandler }}
          WEB_SRV: ${{ matrix.websrv }}
          NAME_SPACE: local

      - name: "Setup tunnel"
        uses: ./.github/actions/wf_specific/ms_ca_handler/tunnel_setup
        with:
          SSH_USER: ${{ env.SSH_USER }}
          SSH_HOST: ${{ env.SSH_HOST }}
          SSH_PORT: ${{ env.SSH_PORT }}
          MSCA_IP: ${{ env.MSCA_IP }}
          MSCA_FQDN_WOTLD: ${{ env.MSCA_FQDN_WOTLD }}
          MSCA_FQDN: ${{ env.MSCA_FQDN }}
          SSH_KNOWN_HOSTS: ${{ env.SSH_KNOWN_HOSTS }}
          SSH_KEY: ${{ env.SSH_KEY }}
          NAME_SPACE: local

      - name: "KRB - Setup a2c with mscertsrv_ca_handler"
        run: |
          sudo touch examples/Docker/data/ca_certs.pem
          sudo chmod 777 examples/Docker/data/ca_certs.pem
          sudo cp test/ca/certsrv_ca_certs.pem examples/Docker/data/ca_certs.pem
          sudo touch examples/Docker/data/acme_srv.cfg
          sudo chmod 777 examples/Docker/data/acme_srv.cfg
          sudo head -n -8 .github/openssl_ca_handler.py_acme_srv_default_handler.cfg > examples/Docker/data/acme_srv.cfg
          sudo echo "handler_file: examples/ca_handler/mscertsrv_ca_handler.py" >> examples/Docker/data/acme_srv.cfg
          sudo echo "host: $MSCA_FQDN" >> examples/Docker/data/acme_srv.cfg
          sudo echo "user: $MSCA_USER" >> examples/Docker/data/acme_srv.cfg
          sudo echo "password: $MSCA_PASSWORD" >> examples/Docker/data/acme_srv.cfg
          sudo echo "auth_method: gssapi" >> examples/Docker/data/acme_srv.cfg
          sudo echo "template: $MSCA_TEMPLATE" >> examples/Docker/data/acme_srv.cfg
          sudo echo "ca_bundle: /var/www/acme2certifier/volume/ca_certs.pem" >> examples/Docker/data/acme_srv.cfg
          sudo echo "krb5_config: /var/www/acme2certifier/volume/krb5.conf" >> examples/Docker/data/acme_srv.cfg
          sudo echo "verify: False" >> examples/Docker/data/acme_srv.cfg
          sudo echo "request_timeout: 30" >> examples/Docker/data/acme_srv.cfg
          sudo sed -i "s/revocation_reason_check_disable: False/revocation_reason_check_disable: False\nenrollment_timeout: 40/g" examples/Docker/data/acme_srv.cfg

          sudo touch examples/Docker/data/krb5.conf
          sudo chmod 777 examples/Docker/data/krb5.conf
          cat <<EOF > examples/Docker/data/krb5.conf
          $KRB5_CONF
          EOF
          cd examples/Docker/
          docker compose restart

      - name: "Test enrollment"
        uses: ./.github/actions/acme_clients
        with:
          REVOCATION: "false"
          VERIFY_CERT: "false"
          USE_CERTBOT: "false"
          TEST_ADL: "false"
          NAME_SPACE: local

      - name: "[ * ] collecting test logs"
        if: ${{ failure() }}
        run: |
          mkdir -p ${{ github.workspace }}/artifact/upload
          sudo cp -rp examples/Docker/data/ ${{ github.workspace }}/artifact/data/
          cd examples/Docker
          docker compose logs > ${{ github.workspace }}/artifact/docker-compose.log
          sudo tar -C ${{ github.workspace }}/artifact/ -cvzf ${{ github.workspace }}/artifact/upload/artifact.tar.gz docker-compose.log data

      - name: "[ * ] uploading artificates"
        uses: actions/upload-artifact@v4
        if: ${{ failure() }}
        with:
          name: mscertsrv_wo_impacket_tests-${{ matrix.websrv }}-${{ matrix.dbhandler }}.tar.gz
          path: ${{ github.workspace }}/artifact/upload/

  # ---------------------------------------------------------
  # Test RPMs mscertsrv
  # ---------------------------------------------------------
  mscertsrv-test-rpm:
    runs-on: ubuntu-latest
    # Prevent workflows from running in forks
    if: github.repository == 'grindsa/acme2certifier1'
    needs: guard
    strategy:
      max-parallel: 1
      fail-fast: false
      matrix:
        rhversion: [8]
        execscript: ['rpm_tester.sh', 'django_tester.sh']

    steps:
      - name: "checkout GIT"
        uses: actions/checkout@v4

      - name: "Parse MSCA_CFG secrets"
        uses: ./.github/actions/parse-json-secret
        with:
          json_secret: ${{ secrets.MSCA_CFG }}

      - name: "Parse GH_CFG secrets"
        uses: ./.github/actions/parse-json-secret
        with:
          json_secret: ${{ secrets.GH_CFG }}

      - name: "Parse SSH_TUNNEL_CFG secrets"
        uses: ./.github/actions/parse-json-secret
        with:
          json_secret: ${{ secrets.SSH_TUNNEL_CFG }}

      - name: "Prepare Alma environment"
        uses: ./.github/actions/rpm_prep
        with:
          GH_USER: ${{ env.GH_USER }}
          GH_SBOM_REPO_TOKEN: ${{ env.GH_SBOM_REPO_TOKEN }}
          RH_VERSION: ${{ matrix.rhversion }}
          RPM_BUILD: false
          NAME_SPACE: "local"

      - name: "Download RPM artifact by name from build run"
        uses: ./.github/actions/download_artifact
        with:
          RUN_ID: ${{ inputs.run_id }}
          ARTIFACT_NAME: acme2certifier-${{ inputs.run_id }}.noarch.rpm
          DESTINATION_PATH: data/
          TOKEN: ${{ secrets.GH_WF_TOKEN }}
          REPO: ${{ github.repository }}

      - name: "Get runner ip"
        run: |
          echo RUNNER_IP=$(ip addr show eth0 | grep -i "inet " | cut -d ' ' -f 6 | cut -d '/' -f 1) >> $GITHUB_ENV
          echo RUNNER_PATH=$(pwd | sed 's_/_\\/_g') >> $GITHUB_ENV

      - run: echo "runner IP is $RUNNER_IP"

      - name: "Setup tunnel"
        uses: ./.github/actions/wf_specific/ms_ca_handler/tunnel_setup
        with:
          SSH_USER: ${{ env.SSH_USER }}
          SSH_HOST: ${{ env.SSH_HOST }}
          SSH_PORT: ${{ env.SSH_PORT }}
          MSCA_IP: ${{ env.MSCA_IP }}
          MSCA_FQDN_WOTLD: ${{ env.MSCA_FQDN_WOTLD }}
          MSCA_FQDN: ${{ env.MSCA_FQDN }}
          SSH_KNOWN_HOSTS: ${{ env.SSH_KNOWN_HOSTS }}
          SSH_KEY: ${{ env.SSH_KEY }}
          NAME_SPACE: local

      - name: "KRB - Setup a2c with mscertsrv_ca_handler using kerberos"
        run: |
          mkdir -p data/volume/acme_ca
          sudo cp test/ca/certsrv_ca_certs.pem data/volume/acme_ca/ca_certs.pem
          sudo touch data/volume/acme_srv.cfg
          sudo chmod 777 data/volume/acme_srv.cfg
          sudo head -n -8 .github/openssl_ca_handler.py_acme_srv_default_handler.cfg > data/volume/acme_srv.cfg
          sudo echo "handler_file: /opt/acme2certifier/examples/ca_handler/mscertsrv_ca_handler.py" >> data/volume/acme_srv.cfg
          sudo echo "host: $MSCA_FQDN" >> data/volume/acme_srv.cfg
          sudo echo "user: $MSCA_USER" >> data/volume/acme_srv.cfg
          sudo echo "password: $MSCA_PASSWORD" >> data/volume/acme_srv.cfg
          sudo echo "auth_method: gssapi" >> data/volume/acme_srv.cfg
          sudo echo "template: $MSCA_TEMPLATE" >> data/volume/acme_srv.cfg
          sudo echo "ca_bundle: volume/acme_ca/ca_certs.pem" >> data/volume/acme_srv.cfg
          sudo echo "krb5_config: volume/acme_ca/krb5.conf" >> data/volume/acme_srv.cfg
          sudo echo "verify: False" >> data/volume/acme_srv.cfg
          sudo echo "request_timeout: 30" >> data/volume/acme_srv.cfg
          sudo sed -i "s/tnauthlist_support: False/tnauthlist_support: False\nheader_info_list: [\"HTTP_USER_AGENT\"]/g" data/volume/acme_srv.cfg
          sudo sed -i "s/revocation_reason_check_disable: False/revocation_reason_check_disable: False\nenrollment_timeout: 40/g" data/volume/acme_srv.cfg
          sudo touch data/volume/acme_ca/krb5.conf
          sudo chmod 777 data/volume/acme_ca/krb5.conf
          cat <<EOF > data/volume/acme_ca/krb5.conf
          $KRB5_CONF
          EOF

      - name: "Execute install script"
        run: |
          docker exec acme-srv sh /tmp/acme2certifier/$EXEC_SCRIPT
          docker exec acme-srv yum install -y krb5-libs
        env:
          EXEC_SCRIPT: ${{ matrix.execscript }}

      - name: "KRB - enrollment mit default profile and headerinfo"
        uses: ./.github/actions/wf_specific/ms_ca_handler/enroll_default_headerinfo
        with:
          NAME_SPACE: local

      - name: "NTLM - Setup a2c with mscertsrv_ca_handler"
        run: |
          sudo head -n -8 .github/openssl_ca_handler.py_acme_srv_default_handler.cfg > data/volume/acme_srv.cfg
          sudo echo "handler_file: /opt/acme2certifier/examples/ca_handler/mscertsrv_ca_handler.py" >> data/volume/acme_srv.cfg
          sudo echo "host: $MSCA_FQDN" >> data/volume/acme_srv.cfg
          sudo echo "user: $MSCA_USER" >> data/volume/acme_srv.cfg
          sudo echo "password: $MSCA_PASSWORD" >> data/volume/acme_srv.cfg
          sudo echo "auth_method: ntlm" >> data/volume/acme_srv.cfg
          sudo echo "template: $MSCA_TEMPLATE" >> data/volume/acme_srv.cfg
          sudo echo "ca_bundle: volume/acme_ca/ca_certs.pem" >> data/volume/acme_srv.cfg
          sudo echo "verify: False" >> data/volume/acme_srv.cfg
          sudo echo "request_timeout: 30" >> data/volume/acme_srv.cfg
          sudo sed -i "s/tnauthlist_support: False/tnauthlist_support: False\nheader_info_list: [\"HTTP_USER_AGENT\"]/g" data/volume/acme_srv.cfg
          sudo sed -i "s/revocation_reason_check_disable: False/revocation_reason_check_disable: False\nenrollment_timeout: 40/g" data/volume/acme_srv.cfg

      - name: "Reconfigure a2c"
        run: |
          docker exec acme-srv sh /tmp/acme2certifier/$EXEC_SCRIPT  restart
        env:
          EXEC_SCRIPT: ${{ matrix.execscript }}

      - name: "NTLM - enrollment mit default profile and headerinfo"
        uses: ./.github/actions/wf_specific/ms_ca_handler/enroll_default_headerinfo
        with:
          NAME_SPACE: local

      - name: "NTLM - Setup a2c with mscertsrv_ca_handler with allowed_domainlist configuration"
        run: |
          sudo sed -i "s/challenge_validation_disable: False/challenge_validation_disable: True/g" data/volume/acme_srv.cfg
          sudo echo "allowed_domainlist: [\"*.acme\", \"foo1.bar\", \"*.bar.local\"]" >> data/volume/acme_srv.cfg

      - name: "NTLM - Reconfigure a2c "
        run: |
          docker exec acme-srv sh /tmp/acme2certifier/rpm_tester.sh restart

      - name: "NTLM - enrollment allowed domainlist"
        uses: ./.github/actions/wf_specific/ms_ca_handler/enroll_allowed_domain_list
        with:
          NAME_SPACE: local

      - name: "Verify allowed_domainlist error"
        run: |
          docker exec acme-srv grep -iE 'FQDN/SAN [^ ]+ not allowed by configuration' /var/log/messages

      - name: "KRB ACME Profiling - Setup a2c with mscertsrv_ca_handler using kerberos"
        run: |
          mkdir -p data/volume/acme_ca
          sudo cp test/ca/certsrv_ca_certs.pem data/volume/acme_ca/ca_certs.pem
          sudo touch data/volume/acme_srv.cfg
          sudo chmod 777 data/volume/acme_srv.cfg
          sudo head -n -8 .github/openssl_ca_handler.py_acme_srv_default_handler.cfg > data/volume/acme_srv.cfg
          sudo echo "handler_file: /opt/acme2certifier/examples/ca_handler/mscertsrv_ca_handler.py" >> data/volume/acme_srv.cfg
          sudo echo "host: $MSCA_FQDN" >> data/volume/acme_srv.cfg
          sudo echo "user: $MSCA_USER" >> data/volume/acme_srv.cfg
          sudo echo "password: $MSCA_PASSWORD" >> data/volume/acme_srv.cfg
          sudo echo "auth_method: gssapi" >> data/volume/acme_srv.cfg
          sudo echo "template: $MSCA_TEMPLATE" >> data/volume/acme_srv.cfg
          sudo echo "ca_bundle: volume/acme_ca/ca_certs.pem" >> data/volume/acme_srv.cfg
          sudo echo "krb5_config: volume/acme_ca/krb5.conf" >> data/volume/acme_srv.cfg
          sudo echo "verify: False" >> data/volume/acme_srv.cfg
          sudo echo "request_timeout: 30" >> data/volume/acme_srv.cfg
          sudo echo "enrollment_config_log: True" >> data/volume/acme_srv.cfg
          sudo sed -i "s/tnauthlist_support: False/tnauthlist_support: False\nprofiles={\"WebServerModified\": \"http:\/\/foo.bar\/acmeca1\", \"WebServer\": \"http:\/\/foo.bar\/acmeca2\", \"profile3\": \"http:\/\/foo.bar\/profile3\"}/g" data/volume/acme_srv.cfg
          sudo sed -i "s/revocation_reason_check_disable: False/revocation_reason_check_disable: False\nenrollment_timeout: 40/g" data/volume/acme_srv.cfg

          sudo touch data/volume/acme_ca/krb5.conf
          sudo chmod 777 data/volume/acme_ca/krb5.conf
          cat <<EOF > data/volume/acme_ca/krb5.conf
          $KRB5_CONF
          EOF

      - name: "Reconfigure a2c"
        run: |
          docker exec acme-srv sh /tmp/acme2certifier/$EXEC_SCRIPT  restart
        env:
          EXEC_SCRIPT: ${{ matrix.execscript }}

      - name: "KRB ACME Profiling - Enrollment"
        uses: ./.github/actions/wf_specific/ms_ca_handler/enroll_acmeprofile
        with:
          NAME_SPACE: local
          DEPLOYMENT_TYPE: rpm
          TAIL_NUMBER: 1900

      - name: "[ * ] collecting test logs"
        if: ${{ failure() }}
        run: |
          mkdir -p ${{ github.workspace }}/artifact/upload
          docker exec acme-srv tar cvfz /tmp/acme2certifier/a2c.tgz /opt/acme2certifier
          sudo rm -rf data/*.rpm
          sudo cp -rp data/ ${{ github.workspace }}/artifact/data/
          docker exec acme-srv ls -la /tmp > ${{ github.workspace }}/artifact/data/tmp_list
          docker exec acme-srv ls -la /tmp
          docker exec acme-srv cat /var/log/messages > ${{ github.workspace }}/artifact/acme-srv.log
          sudo tar -C ${{ github.workspace }}/artifact/ -cvzf ${{ github.workspace }}/artifact/upload/artifact.tar.gz data acme-srv.log

      - name: "[ * ] uploading artificates"
        uses: actions/upload-artifact@v4
        if: ${{ failure() }}
        with:
          name: mscertsrv_handler_tests_rpm-rh${{ matrix.rhversion }}.tar.gz
          path: ${{ github.workspace }}/artifact/upload/

  # ---------------------------------------------------------
  # Test RPMs mscertsrv eab
  # ---------------------------------------------------------
  mscertsrv-eabprofile-test-rpm:
    runs-on: ubuntu-latest
    # Prevent workflows from running in forks
    if: github.repository == 'grindsa/acme2certifier1'
    needs: [guard, mscertsrv-test-rpm]
    strategy:
      max-parallel: 1
      fail-fast: false
      matrix:
        rhversion: [9]
        execscript: ['rpm_tester.sh', 'django_tester.sh']

    steps:
      - name: "checkout GIT"
        uses: actions/checkout@v4

      - name: "Parse MSCA_CFG secrets"
        uses: ./.github/actions/parse-json-secret
        with:
          json_secret: ${{ secrets.MSCA_CFG }}

      - name: "Parse GH_CFG secrets"
        uses: ./.github/actions/parse-json-secret
        with:
          json_secret: ${{ secrets.GH_CFG }}

      - name: "Parse SSH_TUNNEL_CFG secrets"
        uses: ./.github/actions/parse-json-secret
        with:
          json_secret: ${{ secrets.SSH_TUNNEL_CFG }}

      - name: "Prepare Alma environment"
        uses: ./.github/actions/rpm_prep
        with:
          GH_USER: ${{ env.GH_USER }}
          GH_SBOM_REPO_TOKEN: ${{ env.GH_SBOM_REPO_TOKEN }}
          RH_VERSION: ${{ matrix.rhversion }}
          RPM_BUILD: false
          NAME_SPACE: "local"

      - name: "Download RPM artifact by name from build run"
        uses: ./.github/actions/download_artifact
        with:
          RUN_ID: ${{ inputs.run_id }}
          ARTIFACT_NAME: acme2certifier-${{ inputs.run_id }}.noarch.rpm
          DESTINATION_PATH: data/
          TOKEN: ${{ secrets.GH_WF_TOKEN }}
          REPO: ${{ github.repository }}

      - name: "Get runner ip"
        run: |
          echo RUNNER_IP=$(ip addr show eth0 | grep -i "inet " | cut -d ' ' -f 6 | cut -d '/' -f 1) >> $GITHUB_ENV
          echo RUNNER_PATH=$(pwd | sed 's_/_\\/_g') >> $GITHUB_ENV

      - run: echo "runner IP is $RUNNER_IP"

      - name: "Setup tunnel"
        uses: ./.github/actions/wf_specific/ms_ca_handler/tunnel_setup
        with:
          SSH_USER: ${{ env.SSH_USER }}
          SSH_HOST: ${{ env.SSH_HOST }}
          SSH_PORT: ${{ env.SSH_PORT }}
          MSCA_IP: ${{ env.MSCA_IP }}
          MSCA_FQDN_WOTLD: ${{ env.MSCA_FQDN_WOTLD }}
          MSCA_FQDN: ${{ env.MSCA_FQDN }}
          SSH_KNOWN_HOSTS: ${{ env.SSH_KNOWN_HOSTS }}
          SSH_KEY: ${{ env.SSH_KEY }}
          NAME_SPACE: local

      - name: "EAB with headerinfo - Setup a2c with mscertsrv_ca_handler using kerberos"
        run: |
          mkdir -p data/volume/acme_ca
          sudo cp test/ca/certsrv_ca_certs.pem data/volume/acme_ca/ca_certs.pem
          sudo touch data/volume/acme_srv.cfg
          sudo chmod 777 data/volume/acme_srv.cfg
          sudo head -n -8 .github/openssl_ca_handler.py_acme_srv_default_handler.cfg > data/volume/acme_srv.cfg
          sudo echo "handler_file: /opt/acme2certifier/examples/ca_handler/mscertsrv_ca_handler.py" >> data/volume/acme_srv.cfg
          sudo echo "host: $MSCA_FQDN" >> data/volume/acme_srv.cfg
          sudo echo "user: $MSCA_USER" >> data/volume/acme_srv.cfg
          sudo echo "password: $MSCA_PASSWORD" >> data/volume/acme_srv.cfg
          sudo echo "auth_method: gssapi" >> data/volume/acme_srv.cfg
          sudo echo "template: $MSCA_TEMPLATE" >> data/volume/acme_srv.cfg
          sudo echo "ca_bundle: volume/acme_ca/ca_certs.pem" >> data/volume/acme_srv.cfg
          sudo echo "krb5_config: volume/acme_ca/krb5.conf" >> data/volume/acme_srv.cfg
          sudo echo "verify: False" >> data/volume/acme_srv.cfg
          sudo echo "request_timeout: 30" >> data/volume/acme_srv.cfg
          sudo sed -i "s/tnauthlist_support: False/tnauthlist_support: False\nheader_info_list: [\"HTTP_USER_AGENT\"]/g" data/volume/acme_srv.cfg
          sudo sed -i "s/revocation_reason_check_disable: False/revocation_reason_check_disable: False\nenrollment_timeout: 40/g" data/volume/acme_srv.cfg

          sudo echo -e "\n[EABhandler]" >> data/volume/acme_srv.cfg
          sudo echo "eab_handler_file: /opt/acme2certifier/examples/eab_handler/kid_profile_handler.py" >> data/volume/acme_srv.cfg
          sudo echo "key_file: /opt/acme2certifier/volume/acme_ca/kid_profiles.json" >> data/volume/acme_srv.cfg
          sudo echo "eab_profiling: True" >> data/volume/acme_srv.cfg
          sudo cp examples/eab_handler/kid_profiles.json data/volume/acme_ca/kid_profiles.json
          sudo sed -i '29,33d' data/volume/acme_ca/kid_profiles.json
          sudo sed -i '20,22d' data/volume/acme_ca/kid_profiles.json
          sudo chmod 777 data/volume/acme_ca/kid_profiles.json
          sudo sed -i "s/\"profile_id\"\: \[\"profile_1\", \"profile_2\", \"profile_3\"\]/\"template\"\: \[\"WebServerModified\"\, \"WebServer\"]/g" data/volume/acme_ca/kid_profiles.json
          sudo sed -i "s/\"profile_id\"\: \"profile_2\"/\"template\"\: \"WebServerModified\"/g" data/volume/acme_ca/kid_profiles.json
          sudo sed -i "s/\"ca_name\": \"example_ca_2\",/\"unknown_key\": \"unknown_value\"/g" data/volume/acme_ca/kid_profiles.json
          sudo sed -i "s/\"ca_name\": \"example_ca\",/\"unknown_key\": \"unknown_value\"/g" data/volume/acme_ca/kid_profiles.json
          sudo sed -i "s/example.net/local/g" data/volume/acme_ca/kid_profiles.json
          sudo sed -i '18,19d' data/volume/acme_ca/kid_profiles.json
          sudo sed -i '8,9d' data/volume/acme_ca/kid_profiles.json

          sudo touch data/volume/acme_ca/krb5.conf
          sudo chmod 777 data/volume/acme_ca/krb5.conf
          cat <<EOF > data/volume/acme_ca/krb5.conf
          $KRB5_CONF
          EOF

      - name: "Execute install script"
        run: |
          docker exec acme-srv sh /tmp/acme2certifier/$EXEC_SCRIPT
          docker exec acme-srv yum install -y krb5-libs
        env:
          EXEC_SCRIPT: ${{ matrix.execscript }}

      - name: "EAB with headerinfo - enrollment"
        uses: ./.github/actions/wf_specific/ms_ca_handler/enroll_eab
        with:
          NAME_SPACE: local

      - name: "EAB ACME Profiling - Setup a2c with ms_wcce_ca_handler (Kerboros)"
        run: |
          mkdir -p data/volume/acme_ca
          sudo cp test/ca/certsrv_ca_certs.pem data/volume/acme_ca/ca_certs.pem
          sudo touch data/volume/acme_srv.cfg
          sudo chmod 777 data/volume/acme_srv.cfg
          sudo head -n -8 .github/openssl_ca_handler.py_acme_srv_default_handler.cfg > data/volume/acme_srv.cfg
          sudo echo "handler_file: /opt/acme2certifier/examples/ca_handler/mscertsrv_ca_handler.py" >> data/volume/acme_srv.cfg
          sudo echo "host: $MSCA_FQDN" >> data/volume/acme_srv.cfg
          sudo echo "user: $MSCA_USER" >> data/volume/acme_srv.cfg
          sudo echo "password: $MSCA_PASSWORD" >> data/volume/acme_srv.cfg
          sudo echo "auth_method: gssapi" >> data/volume/acme_srv.cfg
          sudo echo "template: $MSCA_TEMPLATE" >> data/volume/acme_srv.cfg
          sudo echo "ca_bundle: volume/acme_ca/ca_certs.pem" >> data/volume/acme_srv.cfg
          sudo echo "krb5_config: volume/acme_ca/krb5.conf" >> data/volume/acme_srv.cfg
          sudo echo "verify: False" >> data/volume/acme_srv.cfg
          sudo echo "request_timeout: 30" >> data/volume/acme_srv.cfg
          sudo echo "enrollment_config_log: True" >> data/volume/acme_srv.cfg
          sudo sed -i "s/tnauthlist_support: False/tnauthlist_support: False\nprofiles={\"WebServerModified\": \"http:\/\/foo.bar\/acmeca1\", \"WebServer\": \"http:\/\/foo.bar\/acmeca2\", \"profile3\": \"http:\/\/foo.bar\/profile3\"}/g" data/volume/acme_srv.cfg
          sudo sed -i "s/revocation_reason_check_disable: False/revocation_reason_check_disable: False\nenrollment_timeout: 40/g" data/volume/acme_srv.cfg

          sudo echo -e "\n[EABhandler]" >> data/volume/acme_srv.cfg
          sudo echo "eab_handler_file: /opt/acme2certifier/examples/eab_handler/kid_profile_handler.py" >> data/volume/acme_srv.cfg
          sudo echo "key_file: /opt/acme2certifier/volume/acme_ca/kid_profiles.json" >> data/volume/acme_srv.cfg
          sudo echo "eab_profiling: True" >> data/volume/acme_srv.cfg

          sudo cp examples/eab_handler/kid_profiles.json data/volume/acme_ca/kid_profiles.json
          sudo sed -i '29,33d' data/volume/acme_ca/kid_profiles.json
          sudo sed -i '20,22d' data/volume/acme_ca/kid_profiles.json
          sudo chmod 777 data/volume/acme_ca/kid_profiles.json
          sudo sed -i "s/\"profile_id\"\: \[\"profile_1\", \"profile_2\", \"profile_3\"\]/\"template\"\: \[\"WebServerModified\"\, \"WebServer\"]/g" data/volume/acme_ca/kid_profiles.json
          sudo sed -i "s/\"profile_id\"\: \"profile_2\"/\"template\"\: \"WebServerModified\"/g" data/volume/acme_ca/kid_profiles.json
          sudo sed -i "s/\"ca_name\": \"example_ca_2\",/\"unknown_key\": \"unknown_value\"/g" data/volume/acme_ca/kid_profiles.json
          sudo sed -i "s/\"ca_name\": \"example_ca\",/\"unknown_key\": \"unknown_value\"/g" data/volume/acme_ca/kid_profiles.json
          sudo sed -i "s/example.net/local/g" data/volume/acme_ca/kid_profiles.json
          sudo sed -i '18,19d' data/volume/acme_ca/kid_profiles.json
          sudo sed -i '8,9d' data/volume/acme_ca/kid_profiles.json

          sudo touch data/volume/acme_ca/krb5.conf
          sudo chmod 777 data/volume/acme_ca/krb5.conf
          cat <<EOF > data/volume/acme_ca/krb5.conf
          $KRB5_CONF
          EOF

      - name: "Reconfigure a2c"
        run: |
          docker exec acme-srv sh /tmp/acme2certifier/$EXEC_SCRIPT  restart
        env:
          EXEC_SCRIPT: ${{ matrix.execscript }}

      - name: "EAB ACME Profiling - Enrollment"
        uses: ./.github/actions/wf_specific/ms_ca_handler/enroll_eab_acmeprofile
        with:
          NAME_SPACE: local
          DEPLOYMENT_TYPE: rpm
          TAIL_NUMBER: 1900

      - name: "[ * ] collecting test logs"
        if: ${{ failure() }}
        run: |
          mkdir -p ${{ github.workspace }}/artifact/upload
          docker exec acme-srv tar cvfz /tmp/acme2certifier/a2c.tgz /opt/acme2certifier
          sudo rm -rf data/*.rpm
          sudo cp -rp data/ ${{ github.workspace }}/artifact/data/
          sudo cp -rp acme-sh/ ${{ github.workspace }}/artifact/acme-sh/
          docker exec acme-srv ls -la /tmp > ${{ github.workspace }}/artifact/data/tmp_list
          docker exec acme-srv ls -la /tmp
          docker exec acme-srv cat /var/log/messages > ${{ github.workspace }}/artifact/acme-srv.log
          sudo tar -C ${{ github.workspace }}/artifact/ -cvzf ${{ github.workspace }}/artifact/upload/artifact.tar.gz data acme-srv.log acme-sh

      - name: "[ * ] uploading artificates"
        uses: actions/upload-artifact@v4
        if: ${{ failure() }}
        with:
          name: mscertsrv-eabprofile-test-rpm-rh${{ matrix.rhversion }}.tar.gz
          path: ${{ github.workspace }}/artifact/upload/

  # ---------------------------------------------------------
  # Test RPMs mswcce
  # ---------------------------------------------------------
  mswcce-tests-rpm:
    runs-on: ubuntu-latest
    # Prevent workflows from running in forks
    if: github.repository == 'grindsa/acme2certifier1'
    needs: guard
    strategy:
      max-parallel: 1
      fail-fast: false
      matrix:
        rhversion: [8]
        execscript: ['rpm_tester.sh', 'django_tester.sh']

    steps:
      - name: "checkout GIT"
        uses: actions/checkout@v4

      - name: "Parse MSCA_CFG secrets"
        uses: ./.github/actions/parse-json-secret
        with:
          json_secret: ${{ secrets.MSCA_CFG }}

      - name: "Parse JSON secret - GH_CFG"
        uses: ./.github/actions/parse-json-secret
        with:
          json_secret: ${{ secrets.GH_CFG }}

      - name: "Parse JSON secret - SSH_TUNNEL_CFG"
        uses: ./.github/actions/parse-json-secret
        with:
          json_secret: ${{ secrets.SSH_TUNNEL_CFG }}

      - name: "Prepare Alma environment"
        uses: ./.github/actions/rpm_prep
        with:
          GH_USER: ${{ env.GH_USER }}
          GH_SBOM_REPO_TOKEN: ${{ env.GH_SBOM_REPO_TOKEN }}
          RH_VERSION: ${{ matrix.rhversion }}
          DJANGO_DB: psql
          RPM_BUILD: false

      - name: "Download RPM artifact by name from build run"
        uses: ./.github/actions/download_artifact
        with:
          RUN_ID: ${{ inputs.run_id }}
          ARTIFACT_NAME: acme2certifier-${{ inputs.run_id }}.noarch.rpm
          DESTINATION_PATH: data/
          TOKEN: ${{ secrets.GH_WF_TOKEN }}
          REPO: ${{ github.repository }}

      - name: "Get runner ip"
        run: |
          echo RUNNER_IP=$(ip addr show eth0 | grep -i "inet " | cut -d ' ' -f 6 | cut -d '/' -f 1) >> $GITHUB_ENV
          echo RUNNER_PATH=$(pwd | sed 's_/_\\/_g') >> $GITHUB_ENV

      - run: echo "runner IP is $RUNNER_IP"
        env:
          RUNNER_IP: ${{ env.RUNNER_IP }}

      - name: "Install dnsmasq"
        run: |
          sudo apt-get update
          sudo apt-get install -y dnsmasq
          sudo systemctl disable systemd-resolved
          sudo systemctl stop systemd-resolved
          # sudo chmod -R 777 /etc/resolv.conf
          # sudo echo "nameserver 8.8.8.8" > /etc/resolv.conf
          sudo mkdir -p dnsmasq
          sudo cp .github/dnsmasq.conf dnsmasq/
          sudo chmod -R 777 dnsmasq/dnsmasq.conf
          sudo sed -i "s/RUNNER_IP/$RUNNER_IP/g" dnsmasq/dnsmasq.conf
          sudo echo "address=/$MSCA_FQDN/$RUNNER_IP" >> dnsmasq/dnsmasq.conf
          sudo echo "address=/$MSCA_ADS_DOMAIN/$RUNNER_IP" >> dnsmasq/dnsmasq.conf
          sudo echo "address=/$WES_HOST/$RUNNER_IP" >> dnsmasq/dnsmasq.conf
          cat dnsmasq/dnsmasq.conf
          sudo cp dnsmasq/dnsmasq.conf /etc/
          sudo sed -i "s/ --local-service/ /g" /etc/init.d/dnsmasq
          sudo systemctl enable dnsmasq
          sudo systemctl start dnsmasq

      - name: "Test dns resulution"
        run: |
          host $MSCA_ADS_DOMAIN ${{ env.RUNNER_IP }}
          host $MSCA_FQDN ${{ env.RUNNER_IP }}
          host $WES_HOST 127.0.0.1


      - name: "Setup tunnel"
        uses: ./.github/actions/wf_specific/ms_ca_handler/tunnel_setup
        with:
          SSH_USER: ${{ env.SSH_USER }}
          SSH_HOST: ${{ env.SSH_HOST }}
          SSH_PORT: ${{ env.SSH_PORT }}
          MSCA_IP: ${{ env.MSCA_IP }}
          MSCA_FQDN_WOTLD: ${{ env.MSCA_FQDN_WOTLD }}
          MSCA_FQDN: ${{ env.MSCA_FQDN }}
          SSH_KNOWN_HOSTS: ${{ env.SSH_KNOWN_HOSTS }}
          SSH_KEY: ${{ env.SSH_KEY }}

      - name: "NTLM - Prepare acme_srv.cfg with ms_wcce_ca_handler"
        run: |
          mkdir -p data/volume/acme_ca
          sudo touch data/volume/acme_ca/ca_certs.pem
          sudo chmod 777 data/volume/acme_ca/ca_certs.pem
          sudo echo "$MSCA_CA_BUNDLE" > data/volume/acme_ca/ca_certs.pem
          sudo touch data/volume/acme_srv.cfg
          sudo chmod 777 data/volume/acme_srv.cfg
          sudo head -n -8 .github/openssl_ca_handler.py_acme_srv_default_handler.cfg > data/volume/acme_srv.cfg
          sudo echo "handler_file: /opt/acme2certifier/examples/ca_handler/mswcce_ca_handler.py" >> data/volume/acme_srv.cfg
          sudo echo "host: $RUNNER_IP" >> data/volume/acme_srv.cfg
          sudo echo "user: $MSCA_USER" >> data/volume/acme_srv.cfg
          sudo echo "password: $MSCA_PASSWORD" >> data/volume/acme_srv.cfg
          sudo echo "template: $MSCA_TEMPLATE" >> data/volume/acme_srv.cfg
          sudo echo "ca_name: $MSCA_NAME" >> data/volume/acme_srv.cfg
          sudo echo "target_domain: $MSCA_ADS_DOMAIN" >> data/volume/acme_srv.cfg
          sudo echo "ca_bundle: /opt/acme2certifier/volume/acme_ca/ca_certs.pem" >> data/volume/acme_srv.cfg
          sudo echo "timeout: 20" >> data/volume/acme_srv.cfg
          sudo sed -i "s/tnauthlist_support: False/tnauthlist_support: False\nheader_info_list: [\"HTTP_USER_AGENT\"]/g" data/volume/acme_srv.cfg
          sudo sed -i "s/revocation_reason_check_disable: False/revocation_reason_check_disable: False\nenrollment_timeout: 40/g" data/volume/acme_srv.cfg

      - name: "Execute install script"
        run: |
          docker exec acme-srv sh /tmp/acme2certifier/$EXEC_SCRIPT
        env:
          EXEC_SCRIPT: ${{ matrix.execscript }}

      - name: "NTLM - enrollment mit default profile and headerinfo"
        uses: ./.github/actions/wf_specific/ms_ca_handler/enroll_default_headerinfo

      - name: "KRB - Setup a2c with ms_wcce_ca_handler (Kerberos)"
        run: |
          mkdir -p data/volume/acme_ca
          sudo touch data/volume/acme_ca/ca_certs.pem
          sudo chmod 777 data/volume/acme_ca/ca_certs.pem
          sudo echo "$MSCA_CA_BUNDLE" > data/volume/acme_ca/ca_certs.pem
          sudo touch data/volume/acme_srv.cfg
          sudo chmod 777 data/volume/acme_srv.cfg
          sudo head -n -8 .github/openssl_ca_handler.py_acme_srv_default_handler.cfg > data/volume/acme_srv.cfg
          sudo echo "handler_file: /opt/acme2certifier/examples/ca_handler/mswcce_ca_handler.py" >> data/volume/acme_srv.cfg
          sudo echo "host: $MSCA_FQDN" >> data/volume/acme_srv.cfg
          sudo echo "user: $MSCA_USER" >> data/volume/acme_srv.cfg
          sudo echo "password: $MSCA_PASSWORD" >> data/volume/acme_srv.cfg
          sudo echo "template: $MSCA_TEMPLATE" >> data/volume/acme_srv.cfg
          sudo echo "ca_name: $MSCA_NAME" >> data/volume/acme_srv.cfg
          sudo echo "target_domain: $MSCA_ADS_DOMAIN" >> data/volume/acme_srv.cfg
          sudo echo "domain_controller: $RUNNER_IP" >> data/volume/acme_srv.cfg
          sudo echo "ca_bundle: /opt/acme2certifier/volume/acme_ca/ca_certs.pem" >> data/volume/acme_srv.cfg
          sudo echo "timeout: 20" >> data/volume/acme_srv.cfg
          sudo echo "use_kerberos: True" >> data/volume/acme_srv.cfg
          sudo sed -i "s/tnauthlist_support: False/tnauthlist_support: False\nheader_info_list: [\"HTTP_USER_AGENT\"]/g" data/volume/acme_srv.cfg
          sudo sed -i "s/revocation_reason_check_disable: False/revocation_reason_check_disable: False\nenrollment_timeout: 40/g" data/volume/acme_srv.cfg
      - name: "Reconfigure a2c"
        run: |
          docker exec acme-srv sh /tmp/acme2certifier/$EXEC_SCRIPT  restart
        env:
          EXEC_SCRIPT: ${{ matrix.execscript }}

      - name: "KRB - enrollment mit default profile and headerinfo"
        uses: ./.github/actions/wf_specific/ms_ca_handler/enroll_default_headerinfo

      - name: "KRB - Setup a2c with mswcce_ca_handler with allowed_domainlist configuration"
        run: |
          sudo sed -i "s/challenge_validation_disable: False/challenge_validation_disable: True/g" data/volume/acme_srv.cfg
          sudo echo "allowed_domainlist: [\"*.acme\", \"foo1.bar\", \"*.bar.local\"]" >> data/volume/acme_srv.cfg

      - name: "Execute install script"
        run: |
          docker exec acme-srv sh /tmp/acme2certifier/$EXEC_SCRIPT
        env:
          EXEC_SCRIPT: ${{ matrix.execscript }}

      - name: "KRB - enrollment allowed domainlist"
        uses: ./.github/actions/wf_specific/ms_ca_handler/enroll_allowed_domain_list

      - name: "Verify allowed_domainlist error"
        run: |
          docker exec acme-srv grep -iE 'FQDN/SAN [^ ]+ not allowed by configuration' /var/log/messages

      - name: "ACME Profiling - Setup a2c with ms_wcce_ca_handler (Kerboros)"
        run: |
          sudo touch data/volume/acme_srv.cfg
          sudo chmod 777 data/volume/acme_srv.cfg
          sudo head -n -8 .github/openssl_ca_handler.py_acme_srv_default_handler.cfg > data/volume/acme_srv.cfg
          sudo echo "handler_file: /opt/acme2certifier/examples/ca_handler/mswcce_ca_handler.py" >> data/volume/acme_srv.cfg
          sudo echo "host: $MSCA_FQDN" >> data/volume/acme_srv.cfg
          sudo echo "user: $MSCA_USER" >> data/volume/acme_srv.cfg
          sudo echo "password: $MSCA_PASSWORD" >> data/volume/acme_srv.cfg
          sudo echo "template: $MSCA_TEMPLATE" >> data/volume/acme_srv.cfg
          sudo echo "ca_name: $MSCA_NAME" >> data/volume/acme_srv.cfg
          sudo echo "target_domain: $MSCA_ADS_DOMAIN" >> data/volume/acme_srv.cfg
          sudo echo "domain_controller: $RUNNER_IP" >> data/volume/acme_srv.cfg
          sudo echo "ca_bundle: /opt/acme2certifier/volume/acme_ca/ca_certs.pem" >> data/volume/acme_srv.cfg
          sudo echo "timeout: 20" >> data/volume/acme_srv.cfg
          sudo echo "use_kerberos: True" >> data/volume/acme_srv.cfg
          sudo echo "enrollment_config_log: True" >> data/volume/acme_srv.cfg
          sudo sed -i "s/tnauthlist_support: False/tnauthlist_support: False\nprofiles={\"WebServerModified\": \"http:\/\/foo.bar\/acmeca1\", \"WebServer\": \"http:\/\/foo.bar\/acmeca2\", \"profile3\": \"http:\/\/foo.bar\/profile3\"}/g" data/volume/acme_srv.cfg
          sudo sed -i "s/revocation_reason_check_disable: False/revocation_reason_check_disable: False\nenrollment_timeout: 40/g" data/volume/acme_srv.cfg

      - name: "ACME Profiling - Execute install script"
        run: |
          docker exec acme-srv sh /tmp/acme2certifier/rpm_tester.sh restart
          docker exec acme-srv yum install -y krb5-libs

      - name: "ACME Profiling - Enrollment"
        uses: ./.github/actions/wf_specific/ms_ca_handler/enroll_acmeprofile
        with:
          DEPLOYMENT_TYPE: rpm

      - name: "[ * ] collecting test logs"
        if: ${{ failure() }}
        run: |
          mkdir -p ${{ github.workspace }}/artifact/upload
          docker exec acme-srv tar cvfz /tmp/acme2certifier/a2c.tgz /opt/acme2certifier
          sudo rm -rf data/*.rpm
          sudo cp -rp data/ ${{ github.workspace }}/artifact/data/
          sudo cp -rp acme-sh/ ${{ github.workspace }}/artifact/acme-sh/
          sudo cp -rp dnsmasq/ ${{ github.workspace }}/artifact/dnsmasq/
          # docker exec acme-srv cat /etc/nginx/nginx.conf.orig > ${{ github.workspace }}/artifact/data/nginx.conf.orig
          # docker exec acme-srv cat /etc/nginx/nginx.conf > ${{ github.workspace }}/artifact/data/nginx.conf
          docker exec acme-srv cat /var/log/messages > ${{ github.workspace }}/artifact/acme-srv.log
          sudo tar -C ${{ github.workspace }}/artifact/ -cvzf ${{ github.workspace }}/artifact/upload/artifact.tar.gz data acme-srv.log acme-sh dnsmasq

      - name: "[ * ] uploading artificates"
        uses: actions/upload-artifact@v4
        if: ${{ failure() }}
        with:
          name: mswcce-test-rpm-rh${{ matrix.rhversion }}.tar.gz
          path: ${{ github.workspace }}/artifact/upload/

  # ---------------------------------------------------------
  # Test RPMs mswcce eabprofile
  # ---------------------------------------------------------
  mswcce-eab-tests-rpm:
    runs-on: ubuntu-latest
    # Prevent workflows from running in forks
    if: github.repository == 'grindsa/acme2certifier1'
    needs: [guard, mswcce-tests-rpm]
    strategy:
      max-parallel: 1
      fail-fast: false
      matrix:
        rhversion: [9]
        execscript: ['rpm_tester.sh', 'django_tester.sh']

    steps:
      - name: "checkout GIT"
        uses: actions/checkout@v4

      - name: "Parse MSCA_CFG secrets"
        uses: ./.github/actions/parse-json-secret
        with:
          json_secret: ${{ secrets.MSCA_CFG }}

      - name: "Parse JSON secret - GH_CFG"
        uses: ./.github/actions/parse-json-secret
        with:
          json_secret: ${{ secrets.GH_CFG }}

      - name: "Parse JSON secret - SSH_TUNNEL_CFG"
        uses: ./.github/actions/parse-json-secret
        with:
          json_secret: ${{ secrets.SSH_TUNNEL_CFG }}

      - name: "Prepare Alma environment"
        uses: ./.github/actions/rpm_prep
        with:
          GH_USER: ${{ env.GH_USER }}
          GH_SBOM_REPO_TOKEN: ${{ env.GH_SBOM_REPO_TOKEN }}
          RH_VERSION: ${{ matrix.rhversion }}
          DJANGO_DB: psql
          RPM_BUILD: false

      - name: "Download RPM artifact by name from build run"
        uses: ./.github/actions/download_artifact
        with:
          RUN_ID: ${{ inputs.run_id }}
          ARTIFACT_NAME: acme2certifier-${{ inputs.run_id }}.noarch.rpm
          DESTINATION_PATH: data/
          TOKEN: ${{ secrets.GH_WF_TOKEN }}
          REPO: ${{ github.repository }}

      - name: "Get runner ip"
        run: |
          echo RUNNER_IP=$(ip addr show eth0 | grep -i "inet " | cut -d ' ' -f 6 | cut -d '/' -f 1) >> $GITHUB_ENV
          echo RUNNER_PATH=$(pwd | sed 's_/_\\/_g') >> $GITHUB_ENV

      - run: echo "runner IP is $RUNNER_IP"
        env:
          RUNNER_IP: ${{ env.RUNNER_IP }}

      - name: "Install dnsmasq"
        run: |
          sudo apt-get update
          sudo apt-get install -y dnsmasq
          sudo systemctl disable systemd-resolved
          sudo systemctl stop systemd-resolved
          # sudo chmod -R 777 /etc/resolv.conf
          # sudo echo "nameserver 8.8.8.8" > /etc/resolv.conf
          sudo mkdir -p dnsmasq
          sudo cp .github/dnsmasq.conf dnsmasq/
          sudo chmod -R 777 dnsmasq/dnsmasq.conf
          sudo sed -i "s/RUNNER_IP/$RUNNER_IP/g" dnsmasq/dnsmasq.conf
          sudo echo "address=/$MSCA_FQDN/$RUNNER_IP" >> dnsmasq/dnsmasq.conf
          sudo echo "address=/$MSCA_ADS_DOMAIN/$RUNNER_IP" >> dnsmasq/dnsmasq.conf
          sudo echo "address=/$WES_HOST/$RUNNER_IP" >> dnsmasq/dnsmasq.conf
          cat dnsmasq/dnsmasq.conf
          sudo cp dnsmasq/dnsmasq.conf /etc/
          sudo sed -i "s/ --local-service/ /g" /etc/init.d/dnsmasq
          sudo systemctl enable dnsmasq
          sudo systemctl start dnsmasq

      - name: "Test dns resulution"
        run: |
          host $MSCA_ADS_DOMAIN ${{ env.RUNNER_IP }}
          host $MSCA_FQDN ${{ env.RUNNER_IP }}
          host $WES_HOST 127.0.0.1

      - name: "Setup tunnel"
        uses: ./.github/actions/wf_specific/ms_ca_handler/tunnel_setup
        with:
          SSH_USER: ${{ env.SSH_USER }}
          SSH_HOST: ${{ env.SSH_HOST }}
          SSH_PORT: ${{ env.SSH_PORT }}
          MSCA_IP: ${{ env.MSCA_IP }}
          MSCA_FQDN_WOTLD: ${{ env.MSCA_FQDN_WOTLD }}
          MSCA_FQDN: ${{ env.MSCA_FQDN }}
          SSH_KNOWN_HOSTS: ${{ env.SSH_KNOWN_HOSTS }}
          SSH_KEY: ${{ env.SSH_KEY }}

      - name: "EAB with headerinfo - Setup a2c with ms_wcce_ca_handler (Kerberos)"
        run: |
          mkdir -p data/volume/acme_ca
          sudo touch data/volume/acme_ca/ca_certs.pem
          sudo chmod 777 data/volume/acme_ca/ca_certs.pem
          sudo echo "$MSCA_CA_BUNDLE" > data/volume/acme_ca/ca_certs.pem
          sudo touch data/volume/acme_srv.cfg
          sudo chmod 777 data/volume/acme_srv.cfg
          sudo head -n -8 .github/openssl_ca_handler.py_acme_srv_default_handler.cfg > data/volume/acme_srv.cfg
          sudo echo "handler_file: /opt/acme2certifier/examples/ca_handler/mswcce_ca_handler.py" >> data/volume/acme_srv.cfg
          sudo echo "host: $MSCA_FQDN" >> data/volume/acme_srv.cfg
          sudo echo "user: $MSCA_USER" >> data/volume/acme_srv.cfg
          sudo echo "password: $MSCA_PASSWORD" >> data/volume/acme_srv.cfg
          sudo echo "template: $MSCA_TEMPLATE" >> data/volume/acme_srv.cfg
          sudo echo "ca_name: $MSCA_NAME" >> data/volume/acme_srv.cfg
          sudo echo "target_domain: $MSCA_ADS_DOMAIN" >> data/volume/acme_srv.cfg
          sudo echo "domain_controller: $RUNNER_IP" >> data/volume/acme_srv.cfg
          sudo echo "ca_bundle: /opt/acme2certifier/volume/acme_ca/ca_certs.pem" >> data/volume/acme_srv.cfg
          sudo echo "timeout: 20" >> data/volume/acme_srv.cfg
          sudo echo "use_kerberos: True" >> data/volume/acme_srv.cfg
          sudo sed -i "s/tnauthlist_support: False/tnauthlist_support: False\nheader_info_list: [\"HTTP_USER_AGENT\"]/g" data/volume/acme_srv.cfg
          sudo sed -i "s/revocation_reason_check_disable: False/revocation_reason_check_disable: False\nenrollment_timeout: 40/g" data/volume/acme_srv.cfg

          sudo echo -e "\n[EABhandler]" >> data/volume/acme_srv.cfg
          sudo echo "eab_handler_file: /opt/acme2certifier/examples/eab_handler/kid_profile_handler.py" >> data/volume/acme_srv.cfg
          sudo echo "key_file: /opt/acme2certifier/volume/acme_ca/kid_profiles.json" >> data/volume/acme_srv.cfg
          sudo echo "eab_profiling: True" >> data/volume/acme_srv.cfg

          sudo cp examples/eab_handler/kid_profiles.json data/volume/acme_ca/kid_profiles.json
          sudo sed -i '29,33d' data/volume/acme_ca/kid_profiles.json
          sudo sed -i '20,22d' data/volume/acme_ca/kid_profiles.json
          sudo chmod 777 data/volume/acme_ca/kid_profiles.json
          sudo sed -i "s/\"profile_id\"\: \[\"profile_1\", \"profile_2\", \"profile_3\"\]/\"template\"\: \[\"WebServerModified\"\, \"WebServer\"]/g" data/volume/acme_ca/kid_profiles.json
          sudo sed -i "s/\"profile_id\"\: \"profile_2\"/\"template\"\: \"WebServerModified\"/g" data/volume/acme_ca/kid_profiles.json
          sudo sed -i "s/\"ca_name\": \"example_ca_2\",/\"unknown_key\": \"unknown_value\"/g" data/volume/acme_ca/kid_profiles.json
          sudo sed -i "s/\"ca_name\": \"example_ca\",/\"unknown_key\": \"unknown_value\"/g" data/volume/acme_ca/kid_profiles.json
          sudo sed -i "s/example.net/acme/g" data/volume/acme_ca/kid_profiles.json
          sudo sed -i '18,19d' data/volume/acme_ca/kid_profiles.json
          sudo sed -i '8,9d' data/volume/acme_ca/kid_profiles.json

      - name: "Execute install script"
        run: |
          docker exec acme-srv sh /tmp/acme2certifier/$EXEC_SCRIPT
        env:
          EXEC_SCRIPT: ${{ matrix.execscript }}

      - name: "EAB with headerinfo - enrollment"
        uses: ./.github/actions/wf_specific/ms_ca_handler/enroll_eab

      - name: "EAB ACME Profiling - Setup a2c with ms_wcce_ca_handler (Kerboros)"
        run: |
          mkdir -p data/volume/acme_ca
          sudo touch data/volume/acme_ca/ca_certs.pem
          sudo chmod 777 data/volume/acme_ca/ca_certs.pem
          sudo echo "$MSCA_CA_BUNDLE" > data/volume/acme_ca/ca_certs.pem
          sudo touch data/volume/acme_srv.cfg
          sudo chmod 777 data/volume/acme_srv.cfg
          sudo head -n -8 .github/openssl_ca_handler.py_acme_srv_default_handler.cfg > data/volume/acme_srv.cfg
          sudo echo "handler_file: /opt/acme2certifier/examples/ca_handler/mswcce_ca_handler.py" >> data/volume/acme_srv.cfg
          sudo echo "host: $MSCA_FQDN" >> data/volume/acme_srv.cfg
          sudo echo "user: $MSCA_USER" >> data/volume/acme_srv.cfg
          sudo echo "password: $MSCA_PASSWORD" >> data/volume/acme_srv.cfg
          sudo echo "template: $MSCA_TEMPLATE" >> data/volume/acme_srv.cfg
          sudo echo "ca_name: $MSCA_NAME" >> data/volume/acme_srv.cfg
          sudo echo "target_domain: $MSCA_ADS_DOMAIN" >> data/volume/acme_srv.cfg
          sudo echo "domain_controller: $RUNNER_IP" >> data/volume/acme_srv.cfg
          sudo echo "ca_bundle: /opt/acme2certifier/volume/acme_ca/ca_certs.pem" >> data/volume/acme_srv.cfg
          sudo echo "timeout: 20" >> data/volume/acme_srv.cfg
          sudo echo "use_kerberos: True" >> data/volume/acme_srv.cfg
          sudo echo "enrollment_config_log: True" >> data/volume/acme_srv.cfg
          sudo sed -i "s/tnauthlist_support: False/tnauthlist_support: False\nprofiles={\"WebServerModified\": \"http:\/\/foo.bar\/acmeca1\", \"WebServer\": \"http:\/\/foo.bar\/acmeca2\", \"profile3\": \"http:\/\/foo.bar\/profile3\"}/g" data/volume/acme_srv.cfg
          sudo sed -i "s/revocation_reason_check_disable: False/revocation_reason_check_disable: False\nenrollment_timeout: 40/g" data/volume/acme_srv.cfg

          sudo echo -e "\n[EABhandler]" >> data/volume/acme_srv.cfg
          sudo echo "eab_handler_file: /opt/acme2certifier/examples/eab_handler/kid_profile_handler.py" >> data/volume/acme_srv.cfg
          sudo echo "key_file: /opt/acme2certifier/volume/acme_ca/kid_profiles.json" >> data/volume/acme_srv.cfg
          sudo echo "eab_profiling: True" >> data/volume/acme_srv.cfg

          sudo cp examples/eab_handler/kid_profiles.json data/volume/acme_ca/kid_profiles.json
          sudo sed -i '29,33d' data/volume/acme_ca/kid_profiles.json
          sudo sed -i '20,22d' data/volume/acme_ca/kid_profiles.json
          sudo chmod 777 data/volume/acme_ca/kid_profiles.json
          sudo sed -i "s/\"profile_id\"\: \[\"profile_1\", \"profile_2\", \"profile_3\"\]/\"template\"\: \[\"WebServerModified\"\, \"WebServer\"]/g" data/volume/acme_ca/kid_profiles.json
          sudo sed -i "s/\"profile_id\"\: \"profile_2\"/\"template\"\: \"WebServerModified\"/g" data/volume/acme_ca/kid_profiles.json
          sudo sed -i "s/\"ca_name\": \"example_ca_2\",/\"unknown_key\": \"unknown_value\"/g" data/volume/acme_ca/kid_profiles.json
          sudo sed -i "s/\"ca_name\": \"example_ca\",/\"unknown_key\": \"unknown_value\"/g" data/volume/acme_ca/kid_profiles.json
          sudo sed -i "s/example.net/acme/g" data/volume/acme_ca/kid_profiles.json
          sudo sed -i '18,19d' data/volume/acme_ca/kid_profiles.json
          sudo sed -i '8,9d' data/volume/acme_ca/kid_profiles.json

      - name: "Execute install script"
        run: |
          docker exec acme-srv sh /tmp/acme2certifier/$EXEC_SCRIPT
        env:
          EXEC_SCRIPT: ${{ matrix.execscript }}

      - name: "EAB ACME Profiling - Enrollment"
        uses: ./.github/actions/wf_specific/ms_ca_handler/enroll_eab_acmeprofile
        with:
          DEPLOYMENT_TYPE: rpm

      - name: "[ * ] collecting test logs"
        if: ${{ failure() }}
        run: |
          mkdir -p ${{ github.workspace }}/artifact/upload
          docker exec acme-srv tar cvfz /tmp/acme2certifier/a2c.tgz /opt/acme2certifier
          sudo rm -rf data/*.rpm
          sudo cp -rp data/ ${{ github.workspace }}/artifact/data/
          sudo cp -rp acme-sh/ ${{ github.workspace }}/artifact/acme-sh/
          sudo cp -rp dnsmasq/ ${{ github.workspace }}/artifact/dnsmasq/
          # docker exec acme-srv cat /etc/nginx/nginx.conf.orig > ${{ github.workspace }}/artifact/data/nginx.conf.orig
          # docker exec acme-srv cat /etc/nginx/nginx.conf > ${{ github.workspace }}/artifact/data/nginx.conf
          docker exec acme-srv cat /var/log/messages > ${{ github.workspace }}/artifact/acme-srv.log
          sudo tar -C ${{ github.workspace }}/artifact/ -cvzf ${{ github.workspace }}/artifact/upload/artifact.tar.gz data acme-srv.log acme-sh dnsmasq

      - name: "[ * ] uploading artificates"
        uses: actions/upload-artifact@v4
        if: ${{ failure() }}
        with:
          name: mswcce_eabprofiling-tests-rpm-rh${{ matrix.rhversion }}.tar.gz
          path: ${{ github.workspace }}/artifact/upload/

  # ---------------------------------------------------------
  # Test DEB mscertsrv
  # ---------------------------------------------------------
  mscertsrv-test-deb:
    needs: guard
    runs-on: ubuntu-latest
    if: github.repository == 'grindsa/acme2certifier'
    strategy:
      fail-fast: false
      matrix:
        websrv: ['apache2', 'nginx']
        execscript: ['deb_tester.sh','django_tester.sh']

    steps:
      - name: "checkout GIT"
        uses: actions/checkout@v4

      - name: "Parse MSCA_CFG secrets"
        uses: ./.github/actions/parse-json-secret
        with:
          json_secret: ${{ secrets.MSCA_CFG }}

      - name: "Parse GH_CFG secrets"
        uses: ./.github/actions/parse-json-secret
        with:
          json_secret: ${{ secrets.GH_CFG }}

      - name: "Parse SSH_TUNNEL_CFG secrets"
        uses: ./.github/actions/parse-json-secret
        with:
          json_secret: ${{ secrets.SSH_TUNNEL_CFG }}

      - name: "Prepare Ubuntu environment"
        if: matrix.execscript == 'deb_tester.sh'
        uses: ./.github/actions/deb_prep
        with:
          DEB_BUILD: false
          NAME_SPACE: local

      - name: "Prepare Ubuntu environment"
        if: matrix.execscript == 'django_tester.sh'
        uses: ./.github/actions/deb_prep
        with:
          DEB_BUILD: false
          DJANGO_DB: psql
          NAME_SPACE: local

      - name: "Download DEB artifact by name from build run"
        uses: ./.github/actions/download_artifact
        with:
          RUN_ID: ${{ inputs.run_id }}
          ARTIFACT_NAME: acme2certifier-${{ inputs.run_id }}-1_all.deb
          DESTINATION_PATH: data/
          TOKEN: ${{ secrets.GH_WF_TOKEN }}
          REPO: ${{ github.repository }}

      - name: "Get runner ip"
        run: |
          echo RUNNER_IP=$(ip addr show eth0 | grep -i "inet " | cut -d ' ' -f 6 | cut -d '/' -f 1) >> $GITHUB_ENV
          echo RUNNER_PATH=$(pwd | sed 's_/_\\/_g') >> $GITHUB_ENV
      - run: echo "runner IP is $RUNNER_IP"
        env:
          RUNNER_IP: ${{ env.RUNNER_IP }}

      - name: "Setup tunnel"
        uses: ./.github/actions/wf_specific/ms_ca_handler/tunnel_setup
        with:
          SSH_USER: ${{ env.SSH_USER }}
          SSH_HOST: ${{ env.SSH_HOST }}
          SSH_PORT: ${{ env.SSH_PORT }}
          MSCA_IP: ${{ env.MSCA_IP }}
          MSCA_FQDN_WOTLD: ${{ env.MSCA_FQDN_WOTLD }}
          MSCA_FQDN: ${{ env.MSCA_FQDN }}
          SSH_KNOWN_HOSTS: ${{ env.SSH_KNOWN_HOSTS }}
          SSH_KEY: ${{ env.SSH_KEY }}
          NAME_SPACE: local

      - name: "KRB - Setup a2c with mscertsrv_ca_handler using kerberos"
        run: |
          mkdir -p data/volume/acme_ca
          sudo cp test/ca/certsrv_ca_certs.pem data/volume/acme_ca/ca_certs.pem
          sudo touch data/volume/acme_srv.cfg
          sudo chmod 777 data/volume/acme_srv.cfg
          sudo head -n -8 .github/openssl_ca_handler.py_acme_srv_default_handler.cfg > data/volume/acme_srv.cfg
          sudo echo "handler_file: /var/www/acme2certifier/examples/ca_handler/mscertsrv_ca_handler.py" >> data/volume/acme_srv.cfg
          sudo echo "host: $MSCA_FQDN" >> data/volume/acme_srv.cfg
          sudo echo "user: $MSCA_USER" >> data/volume/acme_srv.cfg
          sudo echo "password: $MSCA_PASSWORD" >> data/volume/acme_srv.cfg
          sudo echo "auth_method: gssapi" >> data/volume/acme_srv.cfg
          sudo echo "template: $MSCA_TEMPLATE" >> data/volume/acme_srv.cfg
          sudo echo "ca_bundle: volume/acme_ca/ca_certs.pem" >> data/volume/acme_srv.cfg
          sudo echo "krb5_config: volume/acme_ca/krb5.conf" >> data/volume/acme_srv.cfg
          sudo echo "verify: False" >> data/volume/acme_srv.cfg
          sudo echo "request_timeout: 30" >> data/volume/acme_srv.cfg
          sudo sed -i "s/tnauthlist_support: False/tnauthlist_support: False\nheader_info_list: [\"HTTP_USER_AGENT\"]/g" data/volume/acme_srv.cfg
          sudo sed -i "s/revocation_reason_check_disable: False/revocation_reason_check_disable: False\nenrollment_timeout: 40/g" data/volume/acme_srv.cfg
          sudo touch data/volume/acme_ca/krb5.conf
          sudo chmod 777 data/volume/acme_ca/krb5.conf
          cat <<EOF > data/volume/acme_ca/krb5.conf
          $KRB5_CONF
          EOF

      - name: "Execute install script"
        run: |
          docker exec acme-srv bash /tmp/acme2certifier/$EXECSCRIPT install $WEBSRV
          # docker exec acme-srv apt-get install -y python3-gssapi
          docker exec acme-srv rm -rf /etc/krb5.conf
          docker exec acme-srv ln -s /var/www/acme2certifier/volume/acme_ca/krb5.conf /etc/krb5.conf
        env:
          WEBSRV: ${{ matrix.websrv }}
          EXECSCRIPT: ${{ matrix.execscript }}

      - name: "Reconfigure a2c "
        run: |
          docker exec acme-srv bash /tmp/acme2certifier/$EXECSRIPT restart $WEBSRV
        env:
          WEBSRV: ${{ matrix.websrv }}
          EXECSRIPT: ${{ matrix.execscript }}

      - name: "KRB - enrollment default profile and headerinfo"
        uses: ./.github/actions/wf_specific/ms_ca_handler/enroll_default_headerinfo
        with:
          NAME_SPACE: local

      - name: "NTLM - Setup a2c with mscertsrv_ca_handler"
        run: |
          sudo head -n -8 .github/openssl_ca_handler.py_acme_srv_default_handler.cfg > data/volume/acme_srv.cfg
          sudo echo "handler_file: /var/www/acme2certifier/examples/ca_handler/mscertsrv_ca_handler.py" >> data/volume/acme_srv.cfg
          sudo echo "host: $MSCA_FQDN" >> data/volume/acme_srv.cfg
          sudo echo "user: $MSCA_USER" >> data/volume/acme_srv.cfg
          sudo echo "password: $MSCA_PASSWORD" >> data/volume/acme_srv.cfg
          sudo echo "auth_method: ntlm" >> data/volume/acme_srv.cfg
          sudo echo "template: $MSCA_TEMPLATE" >> data/volume/acme_srv.cfg
          sudo echo "ca_bundle: volume/acme_ca/ca_certs.pem" >> data/volume/acme_srv.cfg
          sudo echo "verify: False" >> data/volume/acme_srv.cfg
          sudo echo "request_timeout: 30" >> data/volume/acme_srv.cfg
          sudo sed -i "s/tnauthlist_support: False/tnauthlist_support: False\nheader_info_list: [\"HTTP_USER_AGENT\"]/g" data/volume/acme_srv.cfg
          sudo sed -i "s/revocation_reason_check_disable: False/revocation_reason_check_disable: False\nenrollment_timeout: 40/g" data/volume/acme_srv.cfg

      - name: "Reconfigure a2c "
        run: |
          docker exec acme-srv bash /tmp/acme2certifier/$EXECSRIPT restart $WEBSRV
        env:
          WEBSRV: ${{ matrix.websrv }}
          EXECSRIPT: ${{ matrix.execscript }}

      - name: "NTLM - enrollment mit default profile and headerinfo"
        uses: ./.github/actions/wf_specific/ms_ca_handler/enroll_default_headerinfo
        with:
          NAME_SPACE: local

      - name: "NTLM - Setup a2c with mscertsrv_ca_handler with allowed_domainlist configuration"
        run: |
          sudo sed -i "s/challenge_validation_disable: False/challenge_validation_disable: True/g" data/volume/acme_srv.cfg
          sudo echo "allowed_domainlist: [\"*.acme\", \"foo1.bar\", \"*.bar.local\"]" >> data/volume/acme_srv.cfg

      - name: "Reconfigure a2c "
        run: |
          docker exec acme-srv bash /tmp/acme2certifier/$EXECSRIPT restart $WEBSRV
        env:
          WEBSRV: ${{ matrix.websrv }}
          EXECSRIPT: ${{ matrix.execscript }}

      - name: "NTLM - enrollment allowed domainlist"
        uses: ./.github/actions/wf_specific/ms_ca_handler/enroll_allowed_domain_list
        with:
          NAME_SPACE: local

      - name: "KRB ACME Profiling - Setup a2c with mscertsrv_ca_handler using kerberos"
        run: |
          mkdir -p data/volume/acme_ca
          sudo cp test/ca/certsrv_ca_certs.pem data/volume/acme_ca/ca_certs.pem
          sudo touch data/volume/acme_srv.cfg
          sudo chmod 777 data/volume/acme_srv.cfg
          sudo head -n -8 .github/openssl_ca_handler.py_acme_srv_default_handler.cfg > data/volume/acme_srv.cfg
          sudo echo "handler_file: /var/www/acme2certifier/examples/ca_handler/mscertsrv_ca_handler.py" >> data/volume/acme_srv.cfg
          sudo echo "host: $MSCA_FQDN" >> data/volume/acme_srv.cfg
          sudo echo "user: $MSCA_USER" >> data/volume/acme_srv.cfg
          sudo echo "password: $MSCA_PASSWORD" >> data/volume/acme_srv.cfg
          sudo echo "auth_method: gssapi" >> data/volume/acme_srv.cfg
          sudo echo "template: $MSCA_TEMPLATE" >> data/volume/acme_srv.cfg
          sudo echo "ca_bundle: volume/acme_ca/ca_certs.pem" >> data/volume/acme_srv.cfg
          sudo echo "krb5_config: volume/acme_ca/krb5.conf" >> data/volume/acme_srv.cfg
          sudo echo "verify: False" >> data/volume/acme_srv.cfg
          sudo echo "request_timeout: 30" >> data/volume/acme_srv.cfg
          sudo echo "enrollment_config_log: True" >> data/volume/acme_srv.cfg
          sudo sed -i "s/tnauthlist_support: False/tnauthlist_support: False\nprofiles={\"WebServerModified\": \"http:\/\/foo.bar\/acmeca1\", \"WebServer\": \"http:\/\/foo.bar\/acmeca2\", \"profile3\": \"http:\/\/foo.bar\/profile3\"}/g" data/volume/acme_srv.cfg
          sudo sed -i "s/revocation_reason_check_disable: False/revocation_reason_check_disable: False\nenrollment_timeout: 40/g" data/volume/acme_srv.cfg

          sudo touch data/volume/acme_ca/krb5.conf
          sudo chmod 777 data/volume/acme_ca/krb5.conf
          cat <<EOF > data/volume/acme_ca/krb5.conf
          $KRB5_CONF
          EOF

      - name: "Reconfigure a2c "
        run: |
          docker exec acme-srv bash /tmp/acme2certifier/$EXECSRIPT restart $WEBSRV
        env:
          WEBSRV: ${{ matrix.websrv }}
          EXECSRIPT: ${{ matrix.execscript }}

      - name: "KRB ACME Profiling - Enrollment"
        uses: ./.github/actions/wf_specific/ms_ca_handler/enroll_acmeprofile
        with:
          NAME_SPACE: local
          DEPLOYMENT_TYPE: rpm
          TAIL_NUMBER: 1900

      - name: "[ * ] collecting test logs"
        if: ${{ failure() }}
        run: |
          mkdir -p ${{ github.workspace }}/artifact/upload
          docker exec acme-srv tar cvfz /tmp/acme2certifier/a2c.tgz /var/www/acme2certifier
          sudo cp -rp data/ ${{ github.workspace }}/artifact/data/
          sudo rm ${{ github.workspace }}/artifact/data/*.deb
          if [ ${{ matrix.websrv }} == "apache2" ]; then
            docker exec acme-srv cat /var/log/apache2/error.log > ${{ github.workspace }}/artifact/acme-srv.log
          else
            docker exec acme-srv cat /var/log/nginx/error.log > ${{ github.workspace }}/artifact/acme-srv.log
          fi
          docker exec acme-srv cat /var/log/syslog > ${{ github.workspace }}/artifact/syslog
          sudo tar -C ${{ github.workspace }}/artifact/ -cvzf ${{ github.workspace }}/artifact/upload/artifact.tar.gz data acme-srv.log syslog

      - name: "[ * ] uploading artifacts"
        uses: actions/upload-artifact@v4
        if: ${{ failure() }}
        with:
          name: mscertsrv-test-deb-${{ matrix.websrv }}-${{ matrix.execscript }}.tar.gz
          path: ${{ github.workspace }}/artifact/upload/

  # ---------------------------------------------------------
  # Test DEB mswcce
  # ---------------------------------------------------------
  mswcce-test-deb:
    needs: guard
    runs-on: ubuntu-latest
    if: github.repository == 'grindsa/acme2certifier'
    strategy:
      fail-fast: false
      matrix:
        websrv: ['apache2', 'nginx']
        execscript: ['deb_tester.sh','django_tester.sh']

    steps:
      - name: "checkout GIT"
        uses: actions/checkout@v4

      - name: "Parse MSCA_CFG secrets"
        uses: ./.github/actions/parse-json-secret
        with:
          json_secret: ${{ secrets.MSCA_CFG }}

      - name: "Parse GH_CFG secrets"
        uses: ./.github/actions/parse-json-secret
        with:
          json_secret: ${{ secrets.GH_CFG }}

      - name: "Parse SSH_TUNNEL_CFG secrets"
        uses: ./.github/actions/parse-json-secret
        with:
          json_secret: ${{ secrets.SSH_TUNNEL_CFG }}

      - name: "Prepare Ubuntu environment"
        if: matrix.execscript == 'deb_tester.sh'
        uses: ./.github/actions/deb_prep
        with:
          DEB_BUILD: false

      - name: "Prepare Ubuntu environment"
        if: matrix.execscript == 'django_tester.sh'
        uses: ./.github/actions/deb_prep
        with:
          DEB_BUILD: false
          DJANGO_DB: psql

      - name: "Download DEB artifact by name from build run"
        uses: ./.github/actions/download_artifact
        with:
          RUN_ID: ${{ inputs.run_id }}
          ARTIFACT_NAME: acme2certifier-${{ inputs.run_id }}-1_all.deb
          DESTINATION_PATH: data/
          TOKEN: ${{ secrets.GH_WF_TOKEN }}
          REPO: ${{ github.repository }}

      - name: "Get runner ip"
        run: |
          echo RUNNER_IP=$(ip addr show eth0 | grep -i "inet " | cut -d ' ' -f 6 | cut -d '/' -f 1) >> $GITHUB_ENV
          echo RUNNER_PATH=$(pwd | sed 's_/_\\/_g') >> $GITHUB_ENV

      - run: echo "runner IP is $RUNNER_IP"
        env:
          RUNNER_IP: ${{ env.RUNNER_IP }}

      - name: "Install dnsmasq"
        run: |
          sudo apt-get update
          sudo apt-get install -y dnsmasq
          sudo systemctl disable systemd-resolved
          sudo systemctl stop systemd-resolved
          # sudo chmod -R 777 /etc/resolv.conf
          # sudo echo "nameserver 8.8.8.8" > /etc/resolv.conf
          sudo mkdir -p dnsmasq
          sudo cp .github/dnsmasq.conf dnsmasq/
          sudo chmod -R 777 dnsmasq/dnsmasq.conf
          sudo sed -i "s/RUNNER_IP/$RUNNER_IP/g" dnsmasq/dnsmasq.conf
          sudo echo "address=/$MSCA_FQDN/$RUNNER_IP" >> dnsmasq/dnsmasq.conf
          sudo echo "address=/$MSCA_ADS_DOMAIN/$RUNNER_IP" >> dnsmasq/dnsmasq.conf
          sudo echo "address=/$WES_HOST/$RUNNER_IP" >> dnsmasq/dnsmasq.conf
          cat dnsmasq/dnsmasq.conf
          sudo cp dnsmasq/dnsmasq.conf /etc/
          sudo sed -i "s/ --local-service/ /g" /etc/init.d/dnsmasq
          sudo systemctl enable dnsmasq
          sudo systemctl start dnsmasq

      - name: "Test dns resulution"
        run: |
          host $MSCA_ADS_DOMAIN ${{ env.RUNNER_IP }}
          host $MSCA_FQDN ${{ env.RUNNER_IP }}
          host $WES_HOST 127.0.0.1

      - name: "Setup tunnel"
        uses: ./.github/actions/wf_specific/ms_ca_handler/tunnel_setup
        with:
          SSH_USER: ${{ env.SSH_USER }}
          SSH_HOST: ${{ env.SSH_HOST }}
          SSH_PORT: ${{ env.SSH_PORT }}
          MSCA_IP: ${{ env.MSCA_IP }}
          MSCA_FQDN_WOTLD: ${{ env.MSCA_FQDN_WOTLD }}
          MSCA_FQDN: ${{ env.MSCA_FQDN }}
          SSH_KNOWN_HOSTS: ${{ env.SSH_KNOWN_HOSTS }}
          SSH_KEY: ${{ env.SSH_KEY }}

      - name: "NTLM - Prepare acme_srv.cfg with ms_wcce_ca_handler"
        run: |
          mkdir -p data/volume/acme_ca
          sudo touch data/volume/acme_ca/ca_certs.pem
          sudo chmod 777 data/volume/acme_ca/ca_certs.pem
          sudo echo "$MSCA_CA_BUNDLE" > data/volume/acme_ca/ca_certs.pem
          sudo touch data/volume/acme_srv.cfg
          sudo chmod 777 data/volume/acme_srv.cfg
          sudo head -n -8 .github/openssl_ca_handler.py_acme_srv_default_handler.cfg > data/volume/acme_srv.cfg
          sudo echo "handler_file: /var/www/acme2certifier/examples/ca_handler/mswcce_ca_handler.py" >> data/volume/acme_srv.cfg
          sudo echo "host: $RUNNER_IP" >> data/volume/acme_srv.cfg
          sudo echo "user: $MSCA_USER" >> data/volume/acme_srv.cfg
          sudo echo "password: $MSCA_PASSWORD" >> data/volume/acme_srv.cfg
          sudo echo "template: $MSCA_TEMPLATE" >> data/volume/acme_srv.cfg
          sudo echo "ca_name: $MSCA_NAME" >> data/volume/acme_srv.cfg
          sudo echo "target_domain: $MSCA_ADS_DOMAIN" >> data/volume/acme_srv.cfg
          sudo echo "ca_bundle: /var/www/acme2certifier/volume/acme_ca/ca_certs.pem" >> data/volume/acme_srv.cfg
          sudo echo "timeout: 20" >> data/volume/acme_srv.cfg
          sudo sed -i "s/tnauthlist_support: False/tnauthlist_support: False\nheader_info_list: [\"HTTP_USER_AGENT\"]/g" data/volume/acme_srv.cfg
          sudo sed -i "s/revocation_reason_check_disable: False/revocation_reason_check_disable: False\nenrollment_timeout: 40/g" data/volume/acme_srv.cfg

      - name: "Execute install script"
        run: |
          docker exec acme-srv bash /tmp/acme2certifier/$EXECSCRIPT install $WEBSRV
          docker exec acme-srv apt-get install -y python3-impacket
        env:
          WEBSRV: ${{ matrix.websrv }}
          EXECSCRIPT: ${{ matrix.execscript }}

      - name: "NTLM - enrollment mit default profile and headerinfo"
        uses: ./.github/actions/wf_specific/ms_ca_handler/enroll_default_headerinfo

      - name: "KRB - Setup a2c with ms_wcce_ca_handler (Kerberos)"
        run: |
          mkdir -p data/volume/acme_ca
          sudo touch data/volume/acme_ca/ca_certs.pem
          sudo chmod 777 data/volume/acme_ca/ca_certs.pem
          sudo echo "$MSCA_CA_BUNDLE" > data/volume/acme_ca/ca_certs.pem
          sudo touch data/volume/acme_srv.cfg
          sudo chmod 777 data/volume/acme_srv.cfg
          sudo head -n -8 .github/openssl_ca_handler.py_acme_srv_default_handler.cfg > data/volume/acme_srv.cfg
          sudo echo "handler_file: /var/www/acme2certifier/examples/ca_handler/mswcce_ca_handler.py" >> data/volume/acme_srv.cfg
          sudo echo "host: $MSCA_FQDN" >> data/volume/acme_srv.cfg
          sudo echo "user: $MSCA_USER" >> data/volume/acme_srv.cfg
          sudo echo "password: $MSCA_PASSWORD" >> data/volume/acme_srv.cfg
          sudo echo "template: $MSCA_TEMPLATE" >> data/volume/acme_srv.cfg
          sudo echo "ca_name: $MSCA_NAME" >> data/volume/acme_srv.cfg
          sudo echo "target_domain: $MSCA_ADS_DOMAIN" >> data/volume/acme_srv.cfg
          sudo echo "domain_controller: $RUNNER_IP" >> data/volume/acme_srv.cfg
          sudo echo "ca_bundle: /var/www/acme2certifier/volume/acme_ca/ca_certs.pem" >> data/volume/acme_srv.cfg
          sudo echo "timeout: 20" >> data/volume/acme_srv.cfg
          sudo echo "use_kerberos: True" >> data/volume/acme_srv.cfg
          sudo sed -i "s/tnauthlist_support: False/tnauthlist_support: False\nheader_info_list: [\"HTTP_USER_AGENT\"]/g" data/volume/acme_srv.cfg
          sudo sed -i "s/revocation_reason_check_disable: False/revocation_reason_check_disable: False\nenrollment_timeout: 40/g" data/volume/acme_srv.cfg

      - name: "Reconfigure a2c "
        run: |
          docker exec acme-srv bash /tmp/acme2certifier/$EXECSRIPT restart $WEBSRV
        env:
          WEBSRV: ${{ matrix.websrv }}
          EXECSRIPT: ${{ matrix.execscript }}

      - name: "KRB - enrollment mit default profile and headerinfo"
        uses: ./.github/actions/wf_specific/ms_ca_handler/enroll_default_headerinfo

      - name: "KRB - Setup a2c with mswcce_ca_handler with allowed_domainlist configuration"
        run: |
          sudo sed -i "s/challenge_validation_disable: False/challenge_validation_disable: True/g" data/volume/acme_srv.cfg
          sudo echo "allowed_domainlist: [\"*.acme\", \"foo1.bar\", \"*.bar.local\"]" >> data/volume/acme_srv.cfg

      - name: "Reconfigure a2c "
        run: |
          docker exec acme-srv bash /tmp/acme2certifier/$EXECSRIPT restart $WEBSRV
        env:
          WEBSRV: ${{ matrix.websrv }}
          EXECSRIPT: ${{ matrix.execscript }}

      - name: "KRB - enrollment allowed domainlist"
        uses: ./.github/actions/wf_specific/ms_ca_handler/enroll_allowed_domain_list

      - name: "ACME Profiling - Setup a2c with ms_wcce_ca_handler (Kerboros)"
        run: |
          sudo touch data/volume/acme_srv.cfg
          sudo chmod 777 data/volume/acme_srv.cfg
          sudo head -n -8 .github/openssl_ca_handler.py_acme_srv_default_handler.cfg > data/volume/acme_srv.cfg
          sudo echo "handler_file: /var/www/acme2certifier/examples/ca_handler/mswcce_ca_handler.py" >> data/volume/acme_srv.cfg
          sudo echo "host: $MSCA_FQDN" >> data/volume/acme_srv.cfg
          sudo echo "user: $MSCA_USER" >> data/volume/acme_srv.cfg
          sudo echo "password: $MSCA_PASSWORD" >> data/volume/acme_srv.cfg
          sudo echo "template: $MSCA_TEMPLATE" >> data/volume/acme_srv.cfg
          sudo echo "ca_name: $MSCA_NAME" >> data/volume/acme_srv.cfg
          sudo echo "target_domain: $MSCA_ADS_DOMAIN" >> data/volume/acme_srv.cfg
          sudo echo "domain_controller: $RUNNER_IP" >> data/volume/acme_srv.cfg
          sudo echo "ca_bundle: /var/www/acme2certifier/volume/acme_ca/ca_certs.pem" >> data/volume/acme_srv.cfg
          sudo echo "timeout: 20" >> data/volume/acme_srv.cfg
          sudo echo "use_kerberos: True" >> data/volume/acme_srv.cfg
          sudo echo "enrollment_config_log: True" >> data/volume/acme_srv.cfg
          sudo sed -i "s/tnauthlist_support: False/tnauthlist_support: False\nprofiles={\"WebServerModified\": \"http:\/\/foo.bar\/acmeca1\", \"WebServer\": \"http:\/\/foo.bar\/acmeca2\", \"profile3\": \"http:\/\/foo.bar\/profile3\"}/g" data/volume/acme_srv.cfg
          sudo sed -i "s/revocation_reason_check_disable: False/revocation_reason_check_disable: False\nenrollment_timeout: 40/g" data/volume/acme_srv.cfg

      - name: "Reconfigure a2c "
        run: |
          docker exec acme-srv bash /tmp/acme2certifier/$EXECSRIPT restart $WEBSRV
        env:
          WEBSRV: ${{ matrix.websrv }}
          EXECSRIPT: ${{ matrix.execscript }}

      - name: "ACME Profiling - Enrollment"
        uses: ./.github/actions/wf_specific/ms_ca_handler/enroll_acmeprofile
        with:
          DEPLOYMENT_TYPE: deb

      - name: "[ * ] collecting test logs"
        if: ${{ failure() }}
        run: |
          mkdir -p ${{ github.workspace }}/artifact/upload
          docker exec acme-srv tar cvfz /tmp/acme2certifier/a2c.tgz /var/www/acme2certifier
          sudo cp -rp data/ ${{ github.workspace }}/artifact/data/
          sudo rm ${{ github.workspace }}/artifact/data/*.deb
          if [ ${{ matrix.websrv }} == "apache2" ]; then
            docker exec acme-srv cat /var/log/apache2/error.log > ${{ github.workspace }}/artifact/acme-srv.log
          else
            docker exec acme-srv cat /var/log/nginx/error.log > ${{ github.workspace }}/artifact/acme-srv.log
          fi
          docker exec acme-srv cat /var/log/syslog > ${{ github.workspace }}/artifact/syslog
          sudo tar -C ${{ github.workspace }}/artifact/ -cvzf ${{ github.workspace }}/artifact/upload/artifact.tar.gz data acme-srv.log syslog

      - name: "[ * ] uploading artifacts"
        uses: actions/upload-artifact@v4
        if: ${{ failure() }}
        with:
          name: mswcce-test-deb-${{ matrix.websrv }}-${{ matrix.execscript }}.tar.gz
          path: ${{ github.workspace }}/artifact/upload/