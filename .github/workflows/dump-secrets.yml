name: Dump Secrets to JSON

on:
  # push:
  workflow_dispatch:
    inputs:
      secret_list:
        description: 'Comma-separated list of secret names to dump'
        required: true
        default: 'ASA_API_USER,ASA_API_PASSWORD,ASA_API_KEY,ASA_API_HOST,ASA_CA_BUNDLE,ASA_CA_NAME,ASA_CA_NAME2,ASA_PROFILE1,ASA_PROFILE2,ASA_PROFILE3'
      output_filename:
        description: 'Output JSON filename'
        required: false
        default: 'secrets-dump.json'
      mask_values:
        description: 'Mask secret values in logs'
        required: false
        default: 'true'
        type: choice
        options:
        - 'true'
        - 'false'

jobs:
  dump-secrets:
    name: Dump Secrets to JSON
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Dump secrets to JSON
        id: dump-secrets
        uses: ./.github/actions/dump-secrets-to-json
        with:
          # secret_names: ${{ github.event.inputs.secret_list }}
          secret_names: 'ASA_API_USER,ASA_API_PASSWORD,ASA_API_KEY,ASA_API_HOST,ASA_CA_BUNDLE,ASA_CA_NAME,ASA_CA_NAME2,ASA_PROFILE1,ASA_PROFILE2,ASA_PROFILE3'
          output_file: 'secrets-dump.json'
          mask_values: True
          #output_file: ${{ github.event.inputs.output_filename }}
          #mask_values: ${{ github.event.inputs.mask_values }}
        env:
          # API Secrets
          ASA_API_USER: ${{ secrets.ASA_API_USER }}
          ASA_API_PWD: ${{ secrets.ASA_API_PWD }}
          ASA_API_HOST: ${{ secrets.ASA_API_HOST }}
          ASA_API_PORT: ${{ secrets.ASA_API_PORT }}
          ASA_CA_BUNDLE: ${{ secrets.ASA_CA_BUNDLE }}
          ASA_CA_NAME: ${{ secrets.ASA_CA_NAME }}
          ASA_CA_NAME2: ${{ secrets.ASA_CA_NAME2 }}
          ASA_PROFILE1: ${{ secrets.ASA_PROFILE1 }}
          ASA_PROFILE2: ${{ secrets.ASA_PROFILE2 }}
          ASA_PROFILE3: ${{ secrets.ASA_PROFILE3 }}

      - name: Show dump results
        run: |
          echo "‚úÖ JSON file created: ${{ steps.dump-secrets.outputs.json_file }}"
          echo "üìä Secrets processed: ${{ steps.dump-secrets.outputs.secret_count }}"
          echo "üìÅ File size: $(wc -c < '${{ steps.dump-secrets.outputs.json_file }}') bytes"

          # Show file structure (without content for security)
          echo "üìã JSON structure:"
          if command -v jq >/dev/null 2>&1; then
            jq -r 'keys[]' "${{ steps.dump-secrets.outputs.json_file }}" | head -10
            echo "..."
          else
            echo "jq not available, skipping structure preview"
          fi

      - name: Upload JSON as artifact
        uses: actions/upload-artifact@v4
        with:
          name: secrets-dump-${{ github.run_number }}
          path: ${{ steps.dump-secrets.outputs.json_file }}
          retention-days: 1
        if: always()

      - name: Create summary
        run: |
          echo "## üîê Secrets Dump Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| üìÑ Output File | \`${{ steps.dump-secrets.outputs.json_file }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| üî¢ Secrets Processed | ${{ steps.dump-secrets.outputs.secret_count }} |" >> $GITHUB_STEP_SUMMARY
          echo "| üíæ File Size | $(wc -c < '${{ steps.dump-secrets.outputs.json_file }}') bytes |" >> $GITHUB_STEP_SUMMARY
          echo "| üïê Generated | $(date -u +'%Y-%m-%d %H:%M:%S UTC') |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üì¶ Artifact" >> $GITHUB_STEP_SUMMARY
          echo "The JSON file has been uploaded as an artifact: \`secrets-dump-${{ github.run_number }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ‚ö†Ô∏è Security Notice" >> $GITHUB_STEP_SUMMARY
          echo "The uploaded artifact contains sensitive information. Handle with care and delete after use." >> $GITHUB_STEP_SUMMARY
